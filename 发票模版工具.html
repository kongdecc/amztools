<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘ç¥¨ç”Ÿæˆå·¥å…· - by é”å“¥</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ä¸»è¦æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ä½¿ç”¨è¯´æ˜æ ·å¼ */
        .help-section {
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .help-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .help-header h3 {
            margin: 0;
            font-size: 16px;
        }

        #helpToggle {
            transition: transform 0.3s ease;
            font-size: 14px;
        }

        .help-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #f8f9fa;
        }

        .help-content.show {
            max-height: 500px;
            padding: 20px;
        }

        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .help-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .help-item h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .help-item p {
            color: #666;
            font-size: 13px;
            line-height: 1.5;
        }

        /* ä½œè€…ä¿¡æ¯æ ·å¼ */
        .author-info {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .author-info p {
            margin: 0;
            font-size: 14px;
        }

        .author-info strong {
            color: #ffd700;
        }

        .author-info a {
            color: #ffd700;
            text-decoration: underline;
        }

        /* é¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            border-radius: 8px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
        }

        #previewContent {
            transform: scale(0.8);
            transform-origin: top left;
            width: 125%;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .toolbar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-warning { background-color: #ffc107; color: #212529; }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 3px;
            cursor: pointer;
        }

        .btn-remove {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Logoæ›´æ¢æŒ‰é’®æ ·å¼ */
        .btn-change-logo {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,123,255,0.9);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-change-logo:hover {
            background: rgba(0,123,255,1);
        }

        .invoice-container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 800px;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
        }

        .invoice-title h1 {
            font-size: 48px;
            font-weight: bold;
            color: #333;
        }

        .invoice-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-group label {
            font-weight: bold;
            color: #666;
            font-size: 14px;
        }

        .info-group input, .info-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }

        .company-section {
            margin-bottom: 30px;
        }

        .company-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .company-from {
            flex: 1;
            margin-right: 20px;
        }

        .company-from label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #666;
        }

        .company-from textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }

        .template-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            align-items: center;
        }

        .template-controls select {
            flex: 1;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .company-logo {
            width: 200px;
            text-align: center;
        }

        .logo-placeholder {
            width: 180px;
            height: 120px;
            border: 2px dashed #ddd;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            position: relative;
            border-radius: 4px;
        }

        .logo-placeholder input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .logo-placeholder img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .bill-to-section {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .bill-to {
            flex: 1;
        }

        .bill-to label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #666;
        }

        .bill-to textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }

        .order-info {
            flex: 1;
        }

        .order-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .order-details .info-group {
            margin-bottom: 15px;
        }

        .order-details .info-group:last-child {
            margin-bottom: 0;
        }

        .products-section {
            margin-top: 30px;
        }

        .product-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .products-table th,
        .products-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .products-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }

        .products-table input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }

        .products-table .product-amount {
            font-weight: bold;
            text-align: right;
        }

        .invoice-total {
            text-align: right;
            margin-top: 20px;
        }

        .total-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 20px;
            padding: 15px 0;
            border-top: 2px solid #333;
            font-size: 18px;
            font-weight: bold;
        }

        .total-label {
            color: #333;
        }

        .total-amount {
            color: #333;
            min-width: 120px;
        }

        /* Logoéšè—æ ·å¼ - é€šç”¨ */
        .company-logo.no-logo {
            display: none !important;
        }
        
        /* æ‰“å°æ ·å¼ */
        @media print {
            body {
                background: white;
                font-size: 10px;  /* æ¢å¤æ›´å°çš„å­—ä½“ */
                line-height: 1.2;  /* å‡å°è¡Œé«˜ */
                margin: 0;
                padding: 0;
            }
            
            .container {
                max-width: none;
                margin: 0;
                padding: 0;
            }
            
            .invoice-container {
                box-shadow: none;
                border-radius: 0;
                padding: 8px;  /* è¿›ä¸€æ­¥å‡å°å†…è¾¹è· */
                margin: 0;
                max-height: none;
                transform: none;
                width: 100%;
            }
            
            /* å‡å°å„åŒºå—é—´è· */
            .invoice-header {
                margin-bottom: 8px;
                padding-bottom: 8px;
            }
            
            .company-section {
                margin-bottom: 8px;
            }
            
            .products-section {
                margin-top: 8px;
                margin-bottom: 8px;
            }
            
            .invoice-title h1 {
                font-size: 28px;  /* è¿›ä¸€æ­¥å‡å°æ ‡é¢˜ */
                margin-bottom: 5px;
                margin-top: 0;
            }
            
            /* ä¼˜åŒ–è¡¨æ ¼æ ·å¼ */
            .products-table {
                margin-bottom: 8px;
                width: 100%;
            }
            
            .products-table th,
            .products-table td {
                padding: 2px 4px;  /* è¿›ä¸€æ­¥å‡å°è¡¨æ ¼å†…è¾¹è· */
                font-size: 9px;  /* æ›´å°çš„è¡¨æ ¼å­—ä½“ */
                line-height: 1.1;
            }
            
            /* ä¼˜åŒ–è¾“å…¥æ¡†æ ·å¼ */
            input, textarea, select {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: inherit !important;
                line-height: inherit !important;
            }
            
            /* ä¼˜åŒ–å…¬å¸ä¿¡æ¯åŒºåŸŸ */
            .company-info {
                margin-bottom: 8px;
            }
            
            .company-from textarea,
            .bill-to textarea {
                line-height: 1.1 !important;
                padding: 0 !important;
            }
            
            /* ä¼˜åŒ–è®¢å•è¯¦æƒ… */
            .order-details {
                background: transparent !important;
                border: 1px solid #ddd !important;
                margin: 2px 0;
                padding: 8px !important;
            }
            
            .order-details .info-group {
                margin-bottom: 4px;
            }
            
            /* ä¼˜åŒ–æ€»è®¡åŒºåŸŸ */
            .invoice-total {
                margin-top: 8px;
            }
            
            .total-row {
                padding: 8px 0;
                font-size: 12px;
            }
            
            /* å‡å°é¡µè¾¹è· */
            @page {
                margin: 0.2in;  /* è¿›ä¸€æ­¥å‡å°é¡µè¾¹è· */
                size: A4;
            }
            
            /* éšè—ä¸å¿…è¦çš„å…ƒç´  */
            .toolbar,
            .template-controls,
            .product-controls,
            .btn,
            .btn-remove,
            .btn-small,
            .btn-change-logo,
            .help-section,
            .author-info {
                display: none !important;
            }
            
            .products-table th:last-child,
            .products-table td:last-child {
                display: none !important;
            }
            
            .logo-placeholder {
                border: none !important;
            }
            
            .company-logo.no-logo {
                display: none !important;
            }
            
            /* ä¼˜åŒ–è¡¨æ ¼åˆ†é¡µ */
            .products-table {
                page-break-inside: auto;
            }
            
            .products-table thead {
                display: table-header-group;
            }
            
            .products-table tr {
                page-break-inside: avoid;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .invoice-container {
                padding: 20px;
            }
            
            .invoice-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .company-info {
                flex-direction: column;
            }
            
            .company-from {
                margin-right: 0;
                margin-bottom: 20px;
            }
            
            .bill-to-section {
                flex-direction: column;
            }
            
            .products-table {
                font-size: 12px;
            }
            
            .products-table input {
                padding: 4px;
                font-size: 12px;
            }
            
            .help-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
            
            #previewContent {
                transform: scale(0.6);
                width: 167%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä½¿ç”¨è¯´æ˜æŠ˜å é¢æ¿ -->
        <div class="help-section">
            <div class="help-header" onclick="toggleHelp()">
                <h3>ğŸ“– ä½¿ç”¨è¯´æ˜ <span id="helpToggle">â–¼</span></h3>
            </div>
            <div class="help-content" id="helpContent">
                <div class="help-grid">
                    <div class="help-item">
                        <h4>ğŸ¢ åŸºæœ¬ä¿¡æ¯</h4>
                        <p>â€¢ å¡«å†™å‘ç¥¨å·å’Œæ—¥æœŸ<br>â€¢ è¾“å…¥å…¬å¸ä¿¡æ¯å’Œä¹°å®¶ä¿¡æ¯<br>â€¢ ä¸Šä¼ å…¬å¸Logoï¼ˆå¯é‡æ–°é€‰æ‹©ï¼‰</p>
                    </div>
                    <div class="help-item">
                        <h4>ğŸ“¦ è®¢å•ä¿¡æ¯</h4>
                        <p>â€¢ é€‰æ‹©è®¢å•æ¥æºï¼ˆAmazonç­‰ï¼‰<br>â€¢ è¾“å…¥è®¢å•å·å’Œå•†å“ç¼–å·<br>â€¢ é€‰æ‹©è´§å¸ç±»å‹</p>
                    </div>
                    <div class="help-item">
                        <h4>ğŸ›ï¸ äº§å“ç®¡ç†</h4>
                        <p>â€¢ æ·»åŠ äº§å“ã€è¿è´¹ã€ç¨è´¹ã€æŠ˜æ‰£<br>â€¢ è‡ªåŠ¨è®¡ç®—é‡‘é¢å’Œæ€»è®¡<br>â€¢ å¯åˆ é™¤ä¸éœ€è¦çš„è¡Œ</p>
                    </div>
                    <div class="help-item">
                        <h4>ğŸ’¾ æ¨¡æ¿åŠŸèƒ½</h4>
                        <p>â€¢ ä¿å­˜å¸¸ç”¨çš„å…¬å¸å’Œä¹°å®¶ä¿¡æ¯<br>â€¢ ä¿å­˜å®Œæ•´å‘ç¥¨æ¨¡æ¿<br>â€¢ å¿«é€ŸåŠ è½½å·²ä¿å­˜çš„æ¨¡æ¿</p>
                    </div>
                    <div class="help-item">
                        <h4>ğŸ“„ å¯¼å‡ºæ‰“å°</h4>
                        <p>â€¢å»ºè®®å¯¼å‡ºå†æ‰“å°ï¼Œä¸è¦ç›´æ¥æ‰“å°ï¼Œæ’ç‰ˆä¸å¦‚å¯¼å‡ºæ•ˆæœå¥½<br>â€¢ é¢„è§ˆå‘ç¥¨æ•ˆæœ<br>â€¢ æ‰“å°å‘ç¥¨<br>â€¢ å¯¼å‡ºä¸ºPDFæ–‡ä»¶</p>
                    </div>
                    <div class="help-item">
                        <h4>ğŸ’¡ å°è´´å£«</h4>
                        <p>â€¢ æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨æœ¬åœ°<br>â€¢ å®Œå…¨ç¦»çº¿ä½¿ç”¨<br>â€¢ æ”¯æŒå¤šç§è´§å¸</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <button id="saveTemplate" class="btn btn-primary">ä¿å­˜æ¨¡æ¿</button>
            <button id="loadTemplate" class="btn btn-secondary">åŠ è½½æ¨¡æ¿</button>
            <button id="previewInvoice" class="btn btn-info">é¢„è§ˆå‘ç¥¨</button>
            <button id="printInvoice" class="btn btn-success">æ‰“å°å‘ç¥¨</button>
            <button id="exportPDF" class="btn btn-info">å¯¼å‡ºPDF</button>
            <button id="newInvoice" class="btn btn-warning">æ–°å»ºå‘ç¥¨</button>
        </div>

        <div class="invoice-container">
            <div class="invoice-header">
                <div class="invoice-title">
                    <h1>INVOICE</h1>
                </div>
                <div class="invoice-info">
                    <div class="info-group">
                        <label>Invoice No.</label>
                        <input type="text" id="invoiceNo" value="INV-0001">
                    </div>
                    <div class="info-group">
                        <label>Date</label>
                        <input type="date" id="invoiceDate">
                    </div>
                </div>
            </div>

            <div class="company-section">
                <div class="company-info">
                    <div class="company-from">
                        <label>Company Name & Address</label>
                        <textarea id="companyInfo" placeholder="å†™åº—é“ºå…¬å¸åå’Œåœ°å€">Company Name
Address Line 1
Address Line 2
City, State ZIP</textarea>
                        <div class="template-controls">
                            <select id="savedCompanies">
                                <option value="">-- Select Saved --</option>
                            </select>
                            <button id="saveCompany" class="btn-small">ä¿å­˜</button>
                            <button id="deleteCompany" class="btn-small">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="company-logo">
                        <div class="logo-placeholder">
                            <span id="logoText">Company Logo</span>
                            <input type="file" id="logoUpload" accept="image/*">
                            <img id="logoPreview" style="display: none;">
                            <button id="changeLogo" class="btn-change-logo" style="display: none;">ä¸Šä¼ å…¬å¸Logoï¼ˆå¯é‡æ–°é€‰æ‹©ï¼‰</button>
                        </div>
                    </div>
                </div>

                <div class="bill-to-section">
                    <div class="bill-to">
                        <label>Bill To</label>
                        <textarea id="buyerInfo" placeholder="ä¹°å®¶åå­—å’Œåœ°å€">Buyer's Name
Address Line 1
Address Line 2
City, State ZIP</textarea>
                        <div class="template-controls">
                            <select id="savedBuyers">
                                <option value="">-- Select Saved --</option>
                            </select>
                            <button id="saveBuyer" class="btn-small">ä¿å­˜</button>
                            <button id="deleteBuyer" class="btn-small">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="order-info">
                        <div class="order-details">
                            <div class="info-group">
                                <label>Order From</label>
                                <input type="text" id="orderFrom" value="Amazon">
                            </div>
                            <div class="info-group">
                                <label>Order No.</label>
                                <input type="text" id="orderNo" placeholder="123-1234567-1234567">
                            </div>
                            <div class="info-group">
                                <label>Item No.</label>
                                <input type="text" id="itemNo" placeholder="Listing/ASIN">
                            </div>
                            <div class="info-group">
                                <label>Currency</label>
                                <select id="currency">
                                    <option value="USD">USD ($)</option>
                                    <option value="EUR">EUR (â‚¬)</option>
                                    <option value="GBP">GBP (Â£)</option>
                                    <option value="CNY">CNY (Â¥)</option>
                                    <option value="JPY">JPY (Â¥)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="products-section">
                <div class="product-controls">
                    <button id="addProduct" class="btn btn-primary">æ·»åŠ äº§å“</button>
                    <button id="addShipping" class="btn btn-secondary">æ·»åŠ è¿è´¹</button>
                    <button id="addTax" class="btn btn-secondary">æ·»åŠ ç¨è´¹</button>
                    <button id="addDiscount" class="btn btn-secondary">æ·»åŠ æŠ˜æ‰£</button>
                </div>

                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>QTY</th>
                            <th>Unit Price</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <tr class="product-row">
                            <td><input type="text" class="product-name" placeholder="product name"></td>
                            <td><input type="number" class="product-qty" value="1" min="1"></td>
                            <td><input type="number" class="product-price" value="0.00" step="0.01" min="0"></td>
                            <td class="product-amount">$0.00</td>
                            <td><button class="btn-remove">åˆ é™¤</button></td>
                        </tr>
                    </tbody>
                </table>

                <div class="invoice-total">
                    <div class="total-row">
                        <span class="total-label">Total</span>
                        <span class="total-amount" id="totalAmount">$0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä½œè€…ä¿¡æ¯ -->
        <div class="author-info">
            <p>ç‰ˆæƒå½’ è·¨å¢ƒä¹è¶£å›­æ‰€æœ‰ ï½œ å®˜ç½‘ï¼š <a href="https://amzlink.top/" target="_blank" rel="noopener noreferrer">https://amzlink.top/</a> ï½œ ä½œè€…ï¼š<strong>é”å“¥</strong></p>
        </div>
    </div>

    <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å‘ç¥¨é¢„è§ˆ</h3>
                <span class="close" onclick="closePreview()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="previewContent"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closePreview()" class="btn btn-secondary">å…³é—­</button>
                <button onclick="printFromPreview()" class="btn btn-success">æ‰“å°</button>
                <button onclick="exportPDFFromPreview()" class="btn btn-info">å¯¼å‡ºPDF</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å‡½æ•°
        function toggleHelp() {
            const content = document.getElementById('helpContent');
            const toggle = document.getElementById('helpToggle');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                toggle.textContent = 'â–¼';
                toggle.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('show');
                toggle.textContent = 'â–²';
                toggle.style.transform = 'rotate(180deg)';
            }
        }

        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }

        function printFromPreview() {
            // å…³é—­é¢„è§ˆçª—å£
            closePreview();
            
            // ä½¿ç”¨ç›´æ¥æ‰“å°æ–¹å¼ï¼Œå’Œä¸»é¡µé¢æ‰“å°ä¿æŒä¸€è‡´
            const logoPreview = document.getElementById('logoPreview');
            const companyLogo = document.querySelector('.company-logo');
            const hasLogo = logoPreview.style.display === 'block' && logoPreview.src;
            
            // å¦‚æœæ²¡æœ‰Logoï¼Œä¸´æ—¶æ·»åŠ no-logoç±»
            if (!hasLogo) {
                companyLogo.classList.add('no-logo');
            }
            
            // æ‰§è¡Œæ‰“å°
            window.print();
            
            // æ‰“å°å®Œæˆåæ¢å¤LogoåŒºåŸŸå¯è§çŠ¶æ€
            setTimeout(() => {
                companyLogo.classList.remove('no-logo');
            }, 1000);
        }

        function exportPDFFromPreview() {
            // è°ƒç”¨ä¸»å®ä¾‹çš„PDFå¯¼å‡ºåŠŸèƒ½
            if (window.invoiceGenerator) {
                window.invoiceGenerator.exportPDF();
            }
            closePreview();
        }

        class InvoiceGenerator {
            constructor() {
                this.currencySymbols = {
                    'USD': '$',
                    'EUR': 'â‚¬',
                    'GBP': 'Â£',
                    'CNY': 'Â¥',
                    'JPY': 'Â¥'
                };
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.loadSavedData();
                this.setDefaultDate();
                this.updateTotal();
                
                // åˆå§‹åŒ–é»˜è®¤äº§å“è¡Œçš„è´§å¸æ ¼å¼
                const defaultAmountCell = document.querySelector('.product-amount');
                if (defaultAmountCell && defaultAmountCell.textContent === '$0.00') {
                    defaultAmountCell.textContent = this.formatCurrency(0);
                }
                
                // é»˜è®¤æŠ˜å ä½¿ç”¨è¯´æ˜
                const helpContent = document.getElementById('helpContent');
                helpContent.classList.add('show');
                setTimeout(() => {
                    toggleHelp();
                }, 1000);
            }
            
            setupEventListeners() {
                // å·¥å…·æ æŒ‰é’®
                document.getElementById('saveTemplate').addEventListener('click', () => this.saveTemplate());
                document.getElementById('loadTemplate').addEventListener('click', () => this.loadTemplate());
                document.getElementById('previewInvoice').addEventListener('click', () => this.previewInvoice());
                document.getElementById('printInvoice').addEventListener('click', () => this.printInvoice());
                document.getElementById('exportPDF').addEventListener('click', () => this.exportPDF());
                document.getElementById('newInvoice').addEventListener('click', () => this.newInvoice());
                
                // äº§å“æ“ä½œ
                document.getElementById('addProduct').addEventListener('click', () => this.addProduct());
                document.getElementById('addShipping').addEventListener('click', () => this.addShipping());
                document.getElementById('addTax').addEventListener('click', () => this.addTax());
                document.getElementById('addDiscount').addEventListener('click', () => this.addDiscount());
                
                // å…¬å¸å’Œä¹°å®¶ä¿¡æ¯ä¿å­˜
                document.getElementById('saveCompany').addEventListener('click', () => this.saveCompanyInfo());
                document.getElementById('deleteCompany').addEventListener('click', () => this.deleteCompanyInfo());
                document.getElementById('saveBuyer').addEventListener('click', () => this.saveBuyerInfo());
                document.getElementById('deleteBuyer').addEventListener('click', () => this.deleteBuyerInfo());
                
                // ä¸‹æ‹‰é€‰æ‹©
                document.getElementById('savedCompanies').addEventListener('change', (e) => this.loadCompanyInfo(e.target.value));
                document.getElementById('savedBuyers').addEventListener('change', (e) => this.loadBuyerInfo(e.target.value));
                
                // è´§å¸å˜åŒ–
                document.getElementById('currency').addEventListener('change', () => this.updateTotal());
                
                // Logoä¸Šä¼ å’Œæ›´æ¢
                document.getElementById('logoUpload').addEventListener('change', (e) => this.handleLogoUpload(e));
                document.getElementById('changeLogo').addEventListener('click', () => this.changeLogo());
                
                // äº§å“è¡¨æ ¼äº‹ä»¶å§”æ‰˜
                document.getElementById('productsTableBody').addEventListener('input', (e) => {
                    if (e.target.classList.contains('product-qty') || e.target.classList.contains('product-price')) {
                        this.updateRowAmount(e.target.closest('tr'));
                        this.updateTotal();
                    }
                });
                
                document.getElementById('productsTableBody').addEventListener('click', (e) => {
                    if (e.target.classList.contains('btn-remove')) {
                        this.removeProduct(e.target.closest('tr'));
                    }
                });
            }
            
            setDefaultDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('invoiceDate').value = today;
            }
            
            addProduct(type = 'product', name = '', qty = 1, price = 0) {
                const tbody = document.getElementById('productsTableBody');
                const row = document.createElement('tr');
                row.className = 'product-row';
                
                let placeholder = 'product name';
                if (type === 'shipping') placeholder = 'Shipping Fee';
                else if (type === 'tax') placeholder = 'Tax';
                else if (type === 'discount') placeholder = 'Discount';
                
                row.innerHTML = `
                    <td><input type="text" class="product-name" placeholder="${placeholder}" value="${name}"></td>
                    <td><input type="number" class="product-qty" value="${qty}" min="1"></td>
                    <td><input type="number" class="product-price" value="${price.toFixed(2)}" step="0.01"></td>
                    <td class="product-amount">${this.formatCurrency(qty * price)}</td>
                    <td><button class="btn-remove">åˆ é™¤</button></td>
                `;
                
                tbody.appendChild(row);
                this.updateTotal();
            }
            
            addShipping() {
                this.addProduct('shipping', 'Shipping Fee', 1, 0);
            }
            
            addTax() {
                this.addProduct('tax', 'Tax', 1, 0);
            }
            
            addDiscount() {
                this.addProduct('discount', 'Discount', 1, 0);
            }
            
            removeProduct(row) {
                if (document.querySelectorAll('.product-row').length > 1) {
                    // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
                    this.showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº§å“è¡Œå—ï¼Ÿ', () => {
                        row.remove();
                        this.updateTotal();
                    });
                } else {
                    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªäº§å“è¡Œ');
                }
            }
            
            // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            showConfirmDialog(message, onConfirm) {
                const result = confirm(message + '\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­ï¼Œç‚¹å‡»"å–æ¶ˆ"æ”¾å¼ƒæ“ä½œã€‚');
                if (result && onConfirm) {
                    onConfirm();
                }
            }
            
            updateRowAmount(row) {
                const qty = parseFloat(row.querySelector('.product-qty').value) || 0;
                const price = parseFloat(row.querySelector('.product-price').value) || 0;
                const amount = qty * price;
                row.querySelector('.product-amount').textContent = this.formatCurrency(amount);
            }
            
            updateTotal() {
                let total = 0;
                document.querySelectorAll('.product-row').forEach(row => {
                    const qty = parseFloat(row.querySelector('.product-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.product-price').value) || 0;
                    total += qty * price;
                });
                
                document.getElementById('totalAmount').textContent = this.formatCurrency(total);
            }
            
            formatCurrency(amount) {
                const currency = document.getElementById('currency').value;
                const symbol = this.currencySymbols[currency] || '$';
                return `${symbol}${amount.toFixed(2)}`;
            }
            
            saveCompanyInfo() {
                const companyInfo = document.getElementById('companyInfo').value.trim();
                if (!companyInfo) {
                    alert('è¯·è¾“å…¥å…¬å¸ä¿¡æ¯');
                    return;
                }
                
                const name = prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°:');
                if (!name) return;
                
                const savedCompanies = JSON.parse(localStorage.getItem('savedCompanies') || '{}');
                savedCompanies[name] = companyInfo;
                localStorage.setItem('savedCompanies', JSON.stringify(savedCompanies));
                
                this.loadSavedCompanies();
                alert('å…¬å¸ä¿¡æ¯å·²ä¿å­˜');
            }
            
            deleteCompanyInfo() {
                const select = document.getElementById('savedCompanies');
                const name = select.value;
                if (!name) {
                    alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ¨¡æ¿');
                    return;
                }
                
                this.showConfirmDialog(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ "${name}" å—ï¼Ÿ`, () => {
                    const savedCompanies = JSON.parse(localStorage.getItem('savedCompanies') || '{}');
                    delete savedCompanies[name];
                    localStorage.setItem('savedCompanies', JSON.stringify(savedCompanies));
                    this.loadSavedCompanies();
                    alert('æ¨¡æ¿å·²åˆ é™¤');
                });
            }
            
            loadCompanyInfo(name) {
                if (!name) return;
                const savedCompanies = JSON.parse(localStorage.getItem('savedCompanies') || '{}');
                if (savedCompanies[name]) {
                    document.getElementById('companyInfo').value = savedCompanies[name];
                }
            }
            
            saveBuyerInfo() {
                const buyerInfo = document.getElementById('buyerInfo').value.trim();
                if (!buyerInfo) {
                    alert('è¯·è¾“å…¥ä¹°å®¶ä¿¡æ¯');
                    return;
                }
                
                const name = prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°:');
                if (!name) return;
                
                const savedBuyers = JSON.parse(localStorage.getItem('savedBuyers') || '{}');
                savedBuyers[name] = buyerInfo;
                localStorage.setItem('savedBuyers', JSON.stringify(savedBuyers));
                
                this.loadSavedBuyers();
                alert('ä¹°å®¶ä¿¡æ¯å·²ä¿å­˜');
            }
            
            deleteBuyerInfo() {
                const select = document.getElementById('savedBuyers');
                const name = select.value;
                if (!name) {
                    alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ¨¡æ¿');
                    return;
                }
                
                this.showConfirmDialog(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿ "${name}" å—ï¼Ÿ`, () => {
                    const savedBuyers = JSON.parse(localStorage.getItem('savedBuyers') || '{}');
                    delete savedBuyers[name];
                    localStorage.setItem('savedBuyers', JSON.stringify(savedBuyers));
                    this.loadSavedBuyers();
                    alert('æ¨¡æ¿å·²åˆ é™¤');
                });
            }
            
            loadBuyerInfo(name) {
                if (!name) return;
                const savedBuyers = JSON.parse(localStorage.getItem('savedBuyers') || '{}');
                if (savedBuyers[name]) {
                    document.getElementById('buyerInfo').value = savedBuyers[name];
                }
            }
            
            loadSavedCompanies() {
                const select = document.getElementById('savedCompanies');
                const savedCompanies = JSON.parse(localStorage.getItem('savedCompanies') || '{}');
                
                select.innerHTML = '<option value="">-- Select Saved --</option>';
                Object.keys(savedCompanies).forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });
            }
            
            loadSavedBuyers() {
                const select = document.getElementById('savedBuyers');
                const savedBuyers = JSON.parse(localStorage.getItem('savedBuyers') || '{}');
                
                select.innerHTML = '<option value="">-- Select Saved --</option>';
                Object.keys(savedBuyers).forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });
            }
            
            loadSavedData() {
                this.loadSavedCompanies();
                this.loadSavedBuyers();
            }
            
            handleLogoUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const logoPreview = document.getElementById('logoPreview');
                        const logoText = document.getElementById('logoText');
                        const changeLogo = document.getElementById('changeLogo');
                        
                        logoPreview.src = e.target.result;
                        logoPreview.style.display = 'block';
                        logoText.style.display = 'none';
                        changeLogo.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            changeLogo() {
                document.getElementById('logoUpload').click();
            }
            
            previewInvoice() {
                const invoiceContainer = document.querySelector('.invoice-container');
                const previewContent = document.getElementById('previewContent');
                const modal = document.getElementById('previewModal');
                
                // å…‹éš†å‘ç¥¨å†…å®¹
                previewContent.innerHTML = invoiceContainer.outerHTML;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰Logo
                const logoPreview = document.getElementById('logoPreview');
                const hasLogo = logoPreview.style.display === 'block' && logoPreview.src;
                
                // å¦‚æœæ²¡æœ‰Logoï¼Œåœ¨é¢„è§ˆä¸­æ·»åŠ no-logoç±»
                if (!hasLogo) {
                    const previewCompanyLogo = previewContent.querySelector('.company-logo');
                    if (previewCompanyLogo) {
                        previewCompanyLogo.classList.add('no-logo');
                    }
                }
                
                // éšè—é¢„è§ˆä¸­çš„æ§åˆ¶å…ƒç´ 
                const controlsToHide = previewContent.querySelectorAll('.template-controls, .product-controls, .btn-remove, .btn-change-logo');
                controlsToHide.forEach(el => el.style.display = 'none');
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                modal.style.display = 'block';
            }
            
            saveTemplate() {
                const template = this.getInvoiceData();
                const name = prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°:');
                if (!name) return;
                
                const savedTemplates = JSON.parse(localStorage.getItem('invoiceTemplates') || '{}');
                savedTemplates[name] = template;
                localStorage.setItem('invoiceTemplates', JSON.stringify(savedTemplates));
                
                alert('æ¨¡æ¿å·²ä¿å­˜');
            }
            
            loadTemplate() {
                const savedTemplates = JSON.parse(localStorage.getItem('invoiceTemplates') || '{}');
                const names = Object.keys(savedTemplates);
                
                if (names.length === 0) {
                    alert('æ²¡æœ‰ä¿å­˜çš„æ¨¡æ¿');
                    return;
                }
                
                const name = prompt(`è¯·é€‰æ‹©æ¨¡æ¿:\n${names.map((n, i) => `${i + 1}. ${n}`).join('\n')}\n\nè¯·è¾“å…¥æ¨¡æ¿åç§°:`);
                if (!name || !savedTemplates[name]) {
                    alert('æ¨¡æ¿ä¸å­˜åœ¨');
                    return;
                }
                
                this.setInvoiceData(savedTemplates[name]);
                alert('æ¨¡æ¿å·²åŠ è½½');
            }
            
            getInvoiceData() {
                const products = [];
                document.querySelectorAll('.product-row').forEach(row => {
                    products.push({
                        name: row.querySelector('.product-name').value,
                        qty: row.querySelector('.product-qty').value,
                        price: row.querySelector('.product-price').value
                    });
                });
                
                return {
                    invoiceNo: document.getElementById('invoiceNo').value,
                    invoiceDate: document.getElementById('invoiceDate').value,
                    companyInfo: document.getElementById('companyInfo').value,
                    buyerInfo: document.getElementById('buyerInfo').value,
                    orderFrom: document.getElementById('orderFrom').value,
                    orderNo: document.getElementById('orderNo').value,
                    itemNo: document.getElementById('itemNo').value,
                    currency: document.getElementById('currency').value,
                    products: products,
                    logoSrc: document.getElementById('logoPreview').src || ''
                };
            }
            
            setInvoiceData(data) {
                document.getElementById('invoiceNo').value = data.invoiceNo || '';
                document.getElementById('invoiceDate').value = data.invoiceDate || '';
                document.getElementById('companyInfo').value = data.companyInfo || '';
                document.getElementById('buyerInfo').value = data.buyerInfo || '';
                document.getElementById('orderFrom').value = data.orderFrom || '';
                document.getElementById('orderNo').value = data.orderNo || '';
                document.getElementById('itemNo').value = data.itemNo || '';
                document.getElementById('currency').value = data.currency || 'USD';
                
                // æ¢å¤Logo
                if (data.logoSrc) {
                    const logoPreview = document.getElementById('logoPreview');
                    const logoText = document.getElementById('logoText');
                    const changeLogo = document.getElementById('changeLogo');
                    
                    logoPreview.src = data.logoSrc;
                    logoPreview.style.display = 'block';
                    logoText.style.display = 'none';
                    changeLogo.style.display = 'block';
                }
                
                // æ¸…ç©ºç°æœ‰äº§å“
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = '';
                
                // æ·»åŠ äº§å“
                if (data.products && data.products.length > 0) {
                    data.products.forEach(product => {
                        this.addProduct('product', product.name, product.qty, parseFloat(product.price));
                    });
                } else {
                    this.addProduct();
                }
                
                this.updateTotal();
            }
            
            newInvoice() {
                this.showConfirmDialog('ç¡®å®šè¦åˆ›å»ºæ–°å‘ç¥¨å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«æ¸…ç©ºã€‚', () => {
                    // ç”Ÿæˆæ–°çš„å‘ç¥¨å·
                    const invoiceNo = 'INV-' + String(Date.now()).slice(-4);
                    
                    this.setInvoiceData({
                        invoiceNo: invoiceNo,
                        invoiceDate: new Date().toISOString().split('T')[0],
                        companyInfo: '',
                        buyerInfo: '',
                        orderFrom: 'Amazon',
                        orderNo: '',
                        itemNo: '',
                        currency: 'USD',
                        products: [{ name: '', qty: 1, price: 0 }]
                    });
                    
                    // æ¸…ç©ºlogo
                    const logoPreview = document.getElementById('logoPreview');
                    const logoText = document.getElementById('logoText');
                    const changeLogo = document.getElementById('changeLogo');
                    
                    logoPreview.style.display = 'none';
                    logoText.style.display = 'block';
                    changeLogo.style.display = 'none';
                    document.getElementById('logoUpload').value = '';
                });
            }
            
            printInvoice() {
                // æ£€æŸ¥æ˜¯å¦æœ‰Logo
                const logoPreview = document.getElementById('logoPreview');
                const companyLogo = document.querySelector('.company-logo');
                const hasLogo = logoPreview.style.display === 'block' && logoPreview.src;
                
                // å¦‚æœæ²¡æœ‰Logoï¼Œä¸´æ—¶æ·»åŠ no-logoç±»
                if (!hasLogo) {
                    companyLogo.classList.add('no-logo');
                }
                
                // æ‰§è¡Œæ‰“å°
                window.print();
                
                // æ‰“å°å®Œæˆåæ¢å¤LogoåŒºåŸŸå¯è§çŠ¶æ€
                setTimeout(() => {
                    companyLogo.classList.remove('no-logo');
                }, 1000);
            }
            
            async exportPDF() {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const invoiceContainer = document.querySelector('.invoice-container');
                    const logoPreview = document.getElementById('logoPreview');
                    const companyLogo = document.querySelector('.company-logo');
                    const hasLogo = logoPreview.style.display === 'block' && logoPreview.src;
                    
                    // å¦‚æœæ²¡æœ‰Logoï¼Œä¸´æ—¶æ·»åŠ no-logoç±»
                    if (!hasLogo) {
                        companyLogo.classList.add('no-logo');
                    }
                    
                    // ä¸´æ—¶éšè—ä¸éœ€è¦çš„å…ƒç´ 
                    const elementsToHide = [
                        ...document.querySelectorAll('.template-controls'),
                        ...document.querySelectorAll('.product-controls'),
                        ...document.querySelectorAll('.btn-remove'),
                        ...document.querySelectorAll('.btn-change-logo'),
                        document.querySelector('.toolbar')
                    ];
                    
                    // æ‰‹åŠ¨éšè—è¡¨æ ¼æœ€åä¸€åˆ—ï¼ˆActionåˆ—ï¼‰
                    const lastColumns = [
                        ...document.querySelectorAll('.products-table th:last-child'),
                        ...document.querySelectorAll('.products-table td:last-child')
                    ];
                    
                    elementsToHide.forEach(el => {
                        if (el) el.style.display = 'none';
                    });
                    
                    lastColumns.forEach(el => {
                        if (el) el.style.display = 'none';
                    });
                    
                    // ä½¿ç”¨html2canvasè½¬æ¢ä¸ºå›¾ç‰‡
                    const canvas = await html2canvas(invoiceContainer, {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 295; // A4 height in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    // æ¢å¤éšè—çš„å…ƒç´ 
                    elementsToHide.forEach(el => {
                        if (el) el.style.display = '';
                    });
                    
                    lastColumns.forEach(el => {
                        if (el) el.style.display = '';
                    });
                    
                    // æ¢å¤LogoåŒºåŸŸå¯è§çŠ¶æ€
                    companyLogo.classList.remove('no-logo');
                    
                    const invoiceNo = document.getElementById('invoiceNo').value || 'invoice';
                    pdf.save(`${invoiceNo}.pdf`);
                    
                } catch (error) {
                    console.error('PDFå¯¼å‡ºå¤±è´¥:', error);
                    alert('PDFå¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒæˆ–å°è¯•ä½¿ç”¨æ‰“å°åŠŸèƒ½');
                }
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            window.invoiceGenerator = new InvoiceGenerator();
        });
    </script>
</body>
</html>