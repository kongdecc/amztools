<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºšé©¬é€Šé€€è´§æŠ¥å‘Šåˆ†æå·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        h1 {
            color: #232F3E;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .author {
            color: #666;
            font-size: 0.9em;
        }
        
        .help-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #232F3E;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }
        
        .help-button:hover {
            background-color: #37475A;
            transform: scale(1.1);
        }
        
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .help-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .help-content h2 {
            color: #232F3E;
            margin-bottom: 20px;
        }
        
        .help-content h3 {
            color: #FF9900;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .help-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .help-content li {
            margin-bottom: 8px;
        }
        
        .close-help {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 30px;
            cursor: pointer;
            color: #666;
        }
        
        .close-help:hover {
            color: #333;
        }
        
        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .upload-area {
            border: 2px dashed #FF9900;
            border-radius: 10px;
            padding: 40px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background-color: #FFF8E7;
            border-color: #FF6600;
        }
        
        .upload-area.dragover {
            background-color: #FFF8E7;
            border-color: #FF6600;
        }
        
        #fileInput {
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #FF9900;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        
        .data-table {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #232F3E;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .btn {
            background-color: #FF9900;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin: 10px;
        }
        
        .btn:hover {
            background-color: #FF6600;
        }
        
        .btn-secondary {
            background-color: #232F3E;
        }
        
        .btn-secondary:hover {
            background-color: #37475A;
        }
        
        .hidden {
            display: none;
        }
        
        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            background-color: #FFF3CD;
            border: 1px solid #FFEAA7;
            color: #856404;
        }
        
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .filter-group {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        input[type="date"] {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .comments-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .comment-item {
            padding: 15px;
            border-left: 4px solid #FF9900;
            background-color: #f9f9f9;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        
        .comment-meta {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #FF9900;
            border-bottom: 3px solid #FF9900;
        }
        
        .tab:hover {
            color: #FF6600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>äºšé©¬é€Šé€€è´§æŠ¥å‘Šåˆ†æå·¥å…·</h1>
            <p class="author">ä½œè€…ï¼šé”å“¥</p>
            <button class="help-button" onclick="toggleHelp()">?</button>
        </div>
        
        <!-- ä½¿ç”¨è¯´æ˜å¼¹çª— -->
        <div id="helpModal" class="help-modal">
            <div class="help-content">
                <span class="close-help" onclick="toggleHelp()">&times;</span>
                <h2>ä½¿ç”¨è¯´æ˜</h2>
                
                <h3>ğŸ“Š åŠŸèƒ½æ¦‚è¿°</h3>
                <p>æœ¬å·¥å…·ä¸“ä¸ºäºšé©¬é€Šå–å®¶è®¾è®¡ï¼Œç”¨äºæ·±åº¦åˆ†æé€€è´§æ•°æ®ï¼Œå¸®åŠ©ä¼˜åŒ–äº§å“è´¨é‡å’Œé™ä½é€€è´§ç‡ã€‚</p>
                
                <h3>ğŸ“ æ•°æ®ä¸Šä¼ </h3>
                <ul>
                    <li>æ”¯æŒ Excel (.xlsx, .xls) å’Œ CSV æ ¼å¼</li>
                    <li>å¯é€šè¿‡ç‚¹å‡»æˆ–æ‹–æ‹½æ–¹å¼ä¸Šä¼ æ–‡ä»¶</li>
                    <li>ç¡®ä¿æ•°æ®åŒ…å«ä»¥ä¸‹å­—æ®µï¼šreturn-date, order-id, sku, asin, fnsku, product-name, quantity, fulfillment-center-id, detailed-disposition, reason, status, customer-comments</li>
                </ul>
                
                <h3>ğŸ” æ•°æ®ç­›é€‰</h3>
                <ul>
                    <li><strong>æ—¥æœŸèŒƒå›´</strong>ï¼šé€‰æ‹©ç‰¹å®šæ—¶é—´æ®µçš„é€€è´§æ•°æ®</li>
                    <li><strong>ASINç­›é€‰</strong>ï¼šæŸ¥çœ‹ç‰¹å®šäº§å“çš„é€€è´§æƒ…å†µ</li>
                    <li><strong>é€€è´§åŸå› </strong>ï¼šåˆ†æç‰¹å®šåŸå› çš„é€€è´§</li>
                    <li><strong>é…é€ä¸­å¿ƒ</strong>ï¼šæŸ¥çœ‹ä¸åŒä»“åº“çš„é€€è´§æƒ…å†µ</li>
                </ul>
                
                <h3>ğŸ“ˆ åˆ†æç»´åº¦</h3>
                <ul>
                    <li><strong>åŸºç¡€ç»Ÿè®¡</strong>ï¼šæ€»é€€è´§é‡ã€æ¶‰åŠäº§å“æ•°ã€æ—¥å‡é€€è´§ç­‰</li>
                    <li><strong>åŸå› åˆ†æ</strong>ï¼šé€€è´§åŸå› åˆ†å¸ƒåŠå æ¯”</li>
                    <li><strong>äº§å“æ’å</strong>ï¼šé€€è´§æœ€å¤šçš„äº§å“TOP10</li>
                    <li><strong>è¶‹åŠ¿åˆ†æ</strong>ï¼šæ¯æ—¥é€€è´§æ•°é‡å˜åŒ–</li>
                    <li><strong>ä»“åº“åˆ†æ</strong>ï¼šå„é…é€ä¸­å¿ƒé€€è´§æƒ…å†µ</li>
                    <li><strong>å®¢æˆ·åé¦ˆ</strong>ï¼šå®¢æˆ·è¯„è®ºæ±‡æ€»åˆ†æ</li>
                </ul>
                
                <h3>ğŸ’¾ å¯¼å‡ºåŠŸèƒ½</h3>
                <ul>
                    <li><strong>ExcelæŠ¥å‘Š</strong>ï¼šåŒ…å«æ±‡æ€»æ•°æ®ã€è¯¦ç»†åˆ†æå’ŒåŸå§‹æ•°æ®</li>
                    <li><strong>å›¾è¡¨ä¸‹è½½</strong>ï¼šå°†æ‰€æœ‰å›¾è¡¨ä¿å­˜ä¸ºé«˜æ¸…å›¾ç‰‡</li>
                </ul>
                
                <h3>ğŸ’¡ ä½¿ç”¨æŠ€å·§</h3>
                <ul>
                    <li>å®šæœŸåˆ†æé€€è´§æ•°æ®ï¼ŒåŠæ—¶å‘ç°äº§å“é—®é¢˜</li>
                    <li>é‡ç‚¹å…³æ³¨å®¢æˆ·è¯„è®ºï¼Œäº†è§£é€€è´§çœŸå®åŸå› </li>
                    <li>å¯¹æ¯”ä¸åŒæ—¶æœŸæ•°æ®ï¼Œè¯„ä¼°æ”¹è¿›æ•ˆæœ</li>
                    <li>å…³æ³¨ç‰¹å®šé…é€ä¸­å¿ƒçš„å¼‚å¸¸é€€è´§ç‡</li>
                </ul>
            </div>
        </div>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#FF9900" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <h3 style="margin: 20px 0;">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  Excel æ–‡ä»¶</h3>
                <p style="color: #666;">æ”¯æŒ .xlsx, .xls, .csv æ ¼å¼</p>
            </div>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        </div>
        
        <div id="analysisSection" class="hidden">
            <div class="filter-section">
                <h3 style="margin-bottom: 15px;">æ•°æ®ç­›é€‰</h3>
                <div class="filter-group">
                    <div class="date-range">
                        <label>æ—¥æœŸèŒƒå›´ï¼š</label>
                        <input type="date" id="startDate">
                        <span>è‡³</span>
                        <input type="date" id="endDate">
                    </div>
                    <div>
                        <label>ASINï¼š</label>
                        <select id="asinFilter">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div>
                        <label>é€€è´§åŸå› ï¼š</label>
                        <select id="reasonFilter">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div>
                        <label>é…é€ä¸­å¿ƒï¼š</label>
                        <select id="fcFilter">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="applyFilters()">åº”ç”¨ç­›é€‰</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">é‡ç½®</button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">æ€»é€€è´§æ•°é‡</div>
                    <div class="stat-number" id="totalReturns">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">é€€è´§å•†å“æ€»æ•°</div>
                    <div class="stat-number" id="totalQuantity">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ¶‰åŠASINæ•°</div>
                    <div class="stat-number" id="totalAsins">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ¶‰åŠSKUæ•°</div>
                    <div class="stat-number" id="totalSkus">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡æ¯æ—¥é€€è´§</div>
                    <div class="stat-number" id="avgDaily">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœ€å¸¸è§é€€è´§åŸå› </div>
                    <div class="stat-number" id="topReason" style="font-size: 1.2em;">-</div>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('charts')">å›¾è¡¨åˆ†æ</button>
                <button class="tab" onclick="switchTab('details')">è¯¦ç»†æ•°æ®</button>
                <button class="tab" onclick="switchTab('comments')">å®¢æˆ·åé¦ˆ</button>
            </div>
            
            <div id="chartsTab" class="tab-content active">
                <div class="chart-container">
                    <h3>é€€è´§åŸå› åˆ†å¸ƒ</h3>
                    <div class="chart-wrapper">
                        <canvas id="reasonChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>ASINé€€è´§æ•°é‡æ’è¡Œï¼ˆå‰10ï¼‰</h3>
                    <div class="chart-wrapper">
                        <canvas id="asinChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>é…é€ä¸­å¿ƒé€€è´§åˆ†å¸ƒ</h3>
                    <div class="chart-wrapper">
                        <canvas id="fcChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>é€€è´§è¶‹åŠ¿åˆ†æ</h3>
                    <div class="chart-wrapper">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="detailsTab" class="tab-content">
                <div class="data-table">
                    <h3>äº§å“é€€è´§åˆ†æ</h3>
                    <div style="overflow-x: auto; max-height: 600px;">
                        <table id="analysisTable">
                            <thead>
                                <tr>
                                    <th>ASIN</th>
                                    <th>SKU</th>
                                    <th>äº§å“åç§°</th>
                                    <th>é€€è´§æ¬¡æ•°</th>
                                    <th>é€€è´§æ•°é‡</th>
                                    <th>å æ¯”</th>
                                    <th>ä¸»è¦é€€è´§åŸå› </th>
                                    <th>å®¢æˆ·æŸåç‡</th>
                                    <th>äº§å“ç¼ºé™·ç‡</th>
                                </tr>
                            </thead>
                            <tbody id="analysisTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="data-table">
                    <h3>é…é€ä¸­å¿ƒåˆ†æ</h3>
                    <div style="overflow-x: auto;">
                        <table id="fcTable">
                            <thead>
                                <tr>
                                    <th>é…é€ä¸­å¿ƒ</th>
                                    <th>é€€è´§æ¬¡æ•°</th>
                                    <th>é€€è´§æ•°é‡</th>
                                    <th>å æ¯”</th>
                                    <th>ä¸»è¦é€€è´§åŸå› </th>
                                </tr>
                            </thead>
                            <tbody id="fcTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="commentsTab" class="tab-content">
                <div class="comments-section">
                    <h3>å®¢æˆ·è¯„è®ºåˆ†æ</h3>
                    <p style="color: #666; margin-bottom: 12px;">å…±æ”¶é›†åˆ° <span id="commentCount">0</span> æ¡å®¢æˆ·åé¦ˆ</p>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 12px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="selectAllComments" onchange="onSelectAllChange(this.checked)">
                            å…¨é€‰
                        </label>
                        <button class="btn btn-secondary" onclick="downloadSelectedCommentsText()">ä¸‹è½½é€‰ä¸­</button>
                        <button class="btn btn-secondary" onclick="downloadAllCommentsText()">ä¸‹è½½æ‰€æœ‰åé¦ˆ</button>
                    </div>
                    <div id="commentsList"></div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="exportAnalysis()">å¯¼å‡ºåˆ†ææŠ¥å‘Š</button>
                <button class="btn btn-secondary" onclick="downloadCharts()">ä¸‹è½½å›¾è¡¨</button>
            </div>
        </div>
    </div>

    <script>
        let originalData = [];
        let filteredData = [];
        let charts = {};
        let currentComments = [];
        let selectedCommentIndexes = new Set();
        
        // å¸®åŠ©å¼¹çª—æ§åˆ¶
        function toggleHelp() {
            const modal = document.getElementById('helpModal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            if (tab === 'charts') {
                tabs[0].classList.add('active');
                document.getElementById('chartsTab').classList.add('active');
            } else if (tab === 'details') {
                tabs[1].classList.add('active');
                document.getElementById('detailsTab').classList.add('active');
            } else if (tab === 'comments') {
                tabs[2].classList.add('active');
                document.getElementById('commentsTab').classList.add('active');
            }
        }
        
        // ä¸Šä¼ åŒºåŸŸäº‹ä»¶å¤„ç†
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });
        
        // å¤„ç†æ–‡ä»¶
        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                originalData = jsonData;
                filteredData = jsonData;
                
                if (jsonData.length > 0) {
                    populateFilters();
                    analyzeData();
                    document.getElementById('analysisSection').classList.remove('hidden');
                } else {
                    alert('æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æ•°æ®');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // å¡«å……ç­›é€‰å™¨
        function populateFilters() {
            const asins = [...new Set(originalData.map(item => item.asin).filter(Boolean))];
            const reasons = [...new Set(originalData.map(item => item.reason).filter(Boolean))];
            const fcs = [...new Set(originalData.map(item => item['fulfillment-center-id']).filter(Boolean))];
            
            const asinFilter = document.getElementById('asinFilter');
            asinFilter.innerHTML = '<option value="">å…¨éƒ¨</option>';
            asins.forEach(asin => {
                asinFilter.innerHTML += `<option value="${asin}">${asin}</option>`;
            });
            
            const reasonFilter = document.getElementById('reasonFilter');
            reasonFilter.innerHTML = '<option value="">å…¨éƒ¨</option>';
            reasons.forEach(reason => {
                reasonFilter.innerHTML += `<option value="${reason}">${reason}</option>`;
            });
            
            const fcFilter = document.getElementById('fcFilter');
            fcFilter.innerHTML = '<option value="">å…¨éƒ¨</option>';
            fcs.forEach(fc => {
                fcFilter.innerHTML += `<option value="${fc}">${fc}</option>`;
            });
            
            // è®¾ç½®æ—¥æœŸèŒƒå›´
            const dates = originalData.map(item => new Date(item['return-date'])).filter(d => !isNaN(d));
            if (dates.length > 0) {
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                document.getElementById('startDate').value = minDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = maxDate.toISOString().split('T')[0];
            }
        }
        
        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const asinFilter = document.getElementById('asinFilter').value;
            const reasonFilter = document.getElementById('reasonFilter').value;
            const fcFilter = document.getElementById('fcFilter').value;
            
            filteredData = originalData.filter(item => {
                const itemDate = new Date(item['return-date']);
                
                if (startDate && itemDate < new Date(startDate)) return false;
                if (endDate && itemDate > new Date(endDate + 'T23:59:59')) return false;
                if (asinFilter && item.asin !== asinFilter) return false;
                if (reasonFilter && item.reason !== reasonFilter) return false;
                if (fcFilter && item['fulfillment-center-id'] !== fcFilter) return false;
                
                return true;
            });
            
            analyzeData();
        }
        
        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('asinFilter').value = '';
            document.getElementById('reasonFilter').value = '';
            document.getElementById('fcFilter').value = '';
            populateFilters();
            filteredData = originalData;
            analyzeData();
        }
        
        // åˆ†ææ•°æ®
        function analyzeData() {
            updateStatistics();
            createReasonChart();
            createAsinChart();
            createFCChart();
            createTrendChart();
            updateAnalysisTable();
            updateFCTable();
            updateComments();
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStatistics() {
            const totalReturns = filteredData.length;
            const totalQuantity = filteredData.reduce((sum, item) => {
                return sum + (parseInt(item.quantity) || 1);
            }, 0);
            const uniqueAsins = new Set(filteredData.map(item => item.asin).filter(Boolean)).size;
            const uniqueSkus = new Set(filteredData.map(item => item.sku).filter(Boolean)).size;
            
            // è®¡ç®—æ—¥æœŸèŒƒå›´
            const dates = filteredData.map(item => new Date(item['return-date'])).filter(d => !isNaN(d));
            const daysDiff = dates.length > 0 ? 
                Math.ceil((Math.max(...dates) - Math.min(...dates)) / (1000 * 60 * 60 * 24)) + 1 : 1;
              const avgDaily = (totalReturns / daysDiff).toFixed(1);
              
              // æœ€å¸¸è§é€€è´§åŸå› 
              const reasonCounts = {};
              filteredData.forEach(item => {
                  if (item.reason) {
                      reasonCounts[item.reason] = (reasonCounts[item.reason] || 0) + 1;
                  }
              });
              const topReason = Object.entries(reasonCounts)
                  .sort((a, b) => b[1] - a[1])[0];
              
              document.getElementById('totalReturns').textContent = totalReturns;
              document.getElementById('totalQuantity').textContent = totalQuantity;
              document.getElementById('totalAsins').textContent = uniqueAsins;
              document.getElementById('totalSkus').textContent = uniqueSkus;
              document.getElementById('avgDaily').textContent = avgDaily;
              document.getElementById('topReason').textContent = topReason ? topReason[0] : '-';
          }
          
          // åˆ›å»ºé€€è´§åŸå› å›¾è¡¨
          function createReasonChart() {
              const reasonCounts = {};
              filteredData.forEach(item => {
                  if (item.reason) {
                      reasonCounts[item.reason] = (reasonCounts[item.reason] || 0) + 1;
                  }
              });
              
              const ctx = document.getElementById('reasonChart').getContext('2d');
              
              if (charts.reason) {
                  charts.reason.destroy();
              }
              
              charts.reason = new Chart(ctx, {
                  type: 'pie',
                  data: {
                      labels: Object.keys(reasonCounts),
                      datasets: [{
                          data: Object.values(reasonCounts),
                          backgroundColor: [
                              '#FF9900',
                              '#232F3E',
                              '#37475A',
                              '#FF6600',
                              '#FFA724',
                              '#FFD814',
                              '#C45500',
                              '#8B9DC3'
                          ]
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: {
                              position: 'right'
                          },
                          tooltip: {
                              callbacks: {
                                  label: function(context) {
                                      const label = context.label || '';
                                      const value = context.parsed;
                                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                      const percentage = ((value / total) * 100).toFixed(1);
                                      return `${label}: ${value} (${percentage}%)`;
                                  }
                              }
                          }
                      }
                  }
              });
          }
          
          // åˆ›å»ºASINå›¾è¡¨
          function createAsinChart() {
              // ç»Ÿè®¡æ¯ä¸ª ASIN çš„é€€è´§æ¬¡æ•°åŠå…¶ä¸‹ SKU çš„å‡ºç°æ¬¡æ•°
              const asinStats = {};
              filteredData.forEach(item => {
                  if (!item.asin) return;
                  const asin = item.asin;
                  const sku = item.sku || '-';
                  if (!asinStats[asin]) {
                      asinStats[asin] = { count: 0, skuCounts: {} };
                  }
                  asinStats[asin].count++;
                  asinStats[asin].skuCounts[sku] = (asinStats[asin].skuCounts[sku] || 0) + 1;
              });
              
              // è®¡ç®—æ¯ä¸ª ASIN çš„ Top SKU
              const asinEntries = Object.entries(asinStats).map(([asin, stat]) => {
                  const topSku = Object.entries(stat.skuCounts)
                      .sort((a, b) => b[1] - a[1])[0]?.[0] || '-';
                  return { asin, count: stat.count, topSku };
              }).sort((a, b) => b.count - a.count).slice(0, 10);
              
              // å°†SKUæŒ‰å›ºå®šé•¿åº¦æ¢è¡Œï¼ˆæœ€å¤šä¸¤è¡Œï¼Œè¶…å‡ºçœç•¥ï¼‰
              const formatSkuLabel = (sku) => {
                  const s = String(sku || '-');
                  const maxLineLen = 12;
                  const maxLines = 2;
                  const lines = [];
                  for (let i = 0; i < s.length && lines.length < maxLines; i += maxLineLen) {
                      lines.push(s.slice(i, i + maxLineLen));
                  }
                  if (s.length > maxLineLen * maxLines) {
                      lines[maxLines - 1] = lines[maxLines - 1].slice(0, maxLineLen - 1) + 'â€¦';
                  }
                  return lines;
              };
              
              const ctx = document.getElementById('asinChart').getContext('2d');
              
              if (charts.asin) {
                  charts.asin.destroy();
              }
              
              charts.asin = new Chart(ctx, {
                  type: 'bar',
                  data: {
                      // å¤šè¡Œæ ‡ç­¾ï¼šç¬¬ä¸€è¡Œ ASINï¼Œåç»­è¡Œä¸º Top SKU çš„æŠ˜è¡Œ
                      labels: asinEntries.map(e => [e.asin, ...formatSkuLabel(e.topSku)]),
                      datasets: [{
                          label: 'é€€è´§æ•°é‡',
                          data: asinEntries.map(e => e.count),
                          backgroundColor: '#FF9900',
                          borderColor: '#FF6600',
                          borderWidth: 1,
                          categoryPercentage: 0.9,
                          barPercentage: 0.8
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      layout: {
                          padding: { bottom: 24 }
                      },
                      scales: {
                          x: {
                              offset: true,
                              ticks: {
                                  autoSkip: false,
                                  maxRotation: 0,
                                  font: { size: 10 },
                                  padding: 6
                              }
                          },
                          y: {
                              beginAtZero: true,
                              ticks: {
                                  stepSize: 1
                              }
                          }
                      },
                      plugins: {
                          legend: { display: false },
                          tooltip: {
                              callbacks: {
                                  title: (items) => {
                                      const idx = items[0].dataIndex;
                                      return `ASIN: ${asinEntries[idx].asin}`;
                                  },
                                  label: (ctx) => {
                                      const idx = ctx.dataIndex;
                                      return `SKU: ${asinEntries[idx].topSku} | é€€è´§æ•°é‡: ${asinEntries[idx].count}`;
                                  }
                              }
                          }
                      }
                  }
              });
          }
          
          // åˆ›å»ºé…é€ä¸­å¿ƒå›¾è¡¨
          function createFCChart() {
              const fcCounts = {};
              filteredData.forEach(item => {
                  if (item['fulfillment-center-id']) {
                      fcCounts[item['fulfillment-center-id']] = (fcCounts[item['fulfillment-center-id']] || 0) + 1;
                  }
              });
              
              const ctx = document.getElementById('fcChart').getContext('2d');
              
              if (charts.fc) {
                  charts.fc.destroy();
              }
              
              charts.fc = new Chart(ctx, {
                  type: 'doughnut',
                  data: {
                      labels: Object.keys(fcCounts),
                      datasets: [{
                          data: Object.values(fcCounts),
                          backgroundColor: [
                              '#FF9900',
                              '#232F3E',
                              '#37475A',
                              '#FF6600',
                              '#FFA724',
                              '#FFD814',
                              '#C45500',
                              '#8B9DC3'
                          ]
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: {
                              position: 'right'
                          },
                          tooltip: {
                              callbacks: {
                                  label: function(context) {
                                      const label = context.label || '';
                                      const value = context.parsed;
                                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                      const percentage = ((value / total) * 100).toFixed(1);
                                      return `${label}: ${value} (${percentage}%)`;
                                  }
                              }
                          }
                      }
                  }
              });
          }
          
          // åˆ›å»ºè¶‹åŠ¿å›¾è¡¨
          function createTrendChart() {
              const dailyCounts = {};
              filteredData.forEach(item => {
                  const date = new Date(item['return-date']);
                  if (!isNaN(date)) {
                      const dateStr = date.toISOString().split('T')[0];
                      dailyCounts[dateStr] = (dailyCounts[dateStr] || 0) + 1;
                  }
              });
              
              const sortedDates = Object.keys(dailyCounts).sort();
              
              const ctx = document.getElementById('trendChart').getContext('2d');
              
              if (charts.trend) {
                  charts.trend.destroy();
              }
              
              charts.trend = new Chart(ctx, {
                  type: 'line',
                  data: {
                      labels: sortedDates,
                      datasets: [{
                          label: 'æ¯æ—¥é€€è´§æ•°é‡',
                          data: sortedDates.map(date => dailyCounts[date]),
                          borderColor: '#FF9900',
                          backgroundColor: 'rgba(255, 153, 0, 0.1)',
                          tension: 0.1
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      scales: {
                          y: {
                              beginAtZero: true,
                              ticks: {
                                  stepSize: 1
                              }
                          }
                      }
                  }
              });
          }
          
          // æ›´æ–°åˆ†æè¡¨æ ¼
          function updateAnalysisTable() {
              const productAnalysis = {};
              
              filteredData.forEach(item => {
                  if (!item.asin) return;
                  
                  const key = item.asin;
                  
                  if (!productAnalysis[key]) {
                      productAnalysis[key] = {
                          asin: item.asin,
                          sku: item.sku || '-',
                          productName: item['product-name'] || '-',
                          count: 0,
                          quantity: 0,
                          reasons: {},
                          customerDamaged: 0,
                          defective: 0
                      };
                  }
                  
                  productAnalysis[key].count++;
                  productAnalysis[key].quantity += parseInt(item.quantity) || 1;
                  
                  if (item.reason) {
                      productAnalysis[key].reasons[item.reason] = 
                          (productAnalysis[key].reasons[item.reason] || 0) + 1;
                  }
                  
                  if (item['detailed-disposition'] === 'CUSTOMER_DAMAGED') {
                      productAnalysis[key].customerDamaged++;
                  }
                  
                  if (item['detailed-disposition'] === 'DEFECTIVE') {
                      productAnalysis[key].defective++;
                  }
              });
              
              const tbody = document.getElementById('analysisTableBody');
              tbody.innerHTML = '';
              
              const total = filteredData.length;
              
              Object.entries(productAnalysis)
                  .sort((a, b) => b[1].count - a[1].count)
                  .forEach(([key, data]) => {
                      const sortedReasons = Object.entries(data.reasons)
                          .sort((a, b) => b[1] - a[1]);
                      
                      const row = tbody.insertRow();
                      row.insertCell(0).textContent = data.asin;
                      row.insertCell(1).textContent = data.sku;
                      row.insertCell(2).textContent = data.productName;
                      row.insertCell(3).textContent = data.count;
                      row.insertCell(4).textContent = data.quantity;
                      row.insertCell(5).textContent = `${((data.count / total) * 100).toFixed(1)}%`;
                      row.insertCell(6).textContent = sortedReasons[0] ? sortedReasons[0][0] : '-';
                      row.insertCell(7).textContent = `${((data.customerDamaged / data.count) * 100).toFixed(1)}%`;
                      row.insertCell(8).textContent = `${((data.defective / data.count) * 100).toFixed(1)}%`;
                  });
          }
          
          // æ›´æ–°é…é€ä¸­å¿ƒè¡¨æ ¼
          function updateFCTable() {
              const fcAnalysis = {};
              
              filteredData.forEach(item => {
                  const fc = item['fulfillment-center-id'];
                  if (!fc) return;
                  
                  if (!fcAnalysis[fc]) {
                      fcAnalysis[fc] = {
                          count: 0,
                          quantity: 0,
                          reasons: {}
                      };
                  }
                  
                  fcAnalysis[fc].count++;
                  fcAnalysis[fc].quantity += parseInt(item.quantity) || 1;
                  
                  if (item.reason) {
                      fcAnalysis[fc].reasons[item.reason] = 
                          (fcAnalysis[fc].reasons[item.reason] || 0) + 1;
                  }
              });
              
              const tbody = document.getElementById('fcTableBody');
              tbody.innerHTML = '';
              
              const total = filteredData.length;
              
              Object.entries(fcAnalysis)
                  .sort((a, b) => b[1].count - a[1].count)
                  .forEach(([fc, data]) => {
                      const topReason = Object.entries(data.reasons)
                          .sort((a, b) => b[1] - a[1])[0];
                      
                      const row = tbody.insertRow();
                      row.insertCell(0).textContent = fc;
                      row.insertCell(1).textContent = data.count;
                      row.insertCell(2).textContent = data.quantity;
                      row.insertCell(3).textContent = `${((data.count / total) * 100).toFixed(1)}%`;
                      row.insertCell(4).textContent = topReason ? topReason[0] : '-';
                  });
          }
          
          // ä»…ä¸‹è½½æ–‡æœ¬çš„å¸®åŠ©å‡½æ•°
          function downloadTextFile(filename, text) {
              const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.href = url;
              link.download = filename;
              link.click();
              URL.revokeObjectURL(url);
          }
          
          // ä¸€æ¬¡æ€§ä¸‹è½½å½“å‰ç­›é€‰ç»“æœä¸­çš„æ‰€æœ‰å®¢æˆ·åé¦ˆï¼ˆä»…æ–‡æœ¬ï¼‰
          function downloadAllCommentsText() {
              const comments = filteredData
                  .filter(item => item['customer-comments'] && String(item['customer-comments']).trim())
                  .map(item => String(item['customer-comments']).trim());
              
              if (comments.length === 0) {
                  alert('æ— å¯ä¸‹è½½çš„å®¢æˆ·åé¦ˆå†…å®¹');
                  return;
              }
              
              const text = comments.join('\n');
              const filename = `å®¢æˆ·åé¦ˆæ±‡æ€»_${new Date().toISOString().split('T')[0]}.txt`;
              downloadTextFile(filename, text);
          }
          
          // åŒæ­¥â€œå…¨é€‰â€å¤é€‰æ¡†çŠ¶æ€
          function updateSelectAllCheckbox() {
              const selectAllEl = document.getElementById('selectAllComments');
              if (!selectAllEl) return;
              const total = currentComments.length;
              selectAllEl.checked = total > 0 && selectedCommentIndexes.size === total;
          }
          
          // å…¨é€‰/å–æ¶ˆå…¨é€‰å½“å‰åˆ—è¡¨
          function onSelectAllChange(checked) {
              selectedCommentIndexes.clear();
              const checkboxes = document.querySelectorAll('.comment-select');
              checkboxes.forEach(cb => {
                  cb.checked = checked;
                  const i = parseInt(cb.dataset.index);
                  if (!isNaN(i) && checked) {
                      selectedCommentIndexes.add(i);
                  }
              });
          }
          
          // ä¸‹è½½é€‰ä¸­çš„å®¢æˆ·åé¦ˆï¼ˆä»…æ–‡æœ¬ï¼‰
          function downloadSelectedCommentsText() {
              if (selectedCommentIndexes.size === 0) {
                  alert('è¯·å…ˆé€‰æ‹©éœ€è¦ä¸‹è½½çš„åé¦ˆ');
                  return;
              }
              const selectedTexts = Array.from(selectedCommentIndexes)
                  .sort((a, b) => a - b)
                  .map(i => String(currentComments[i]?.comment || '').trim())
                  .filter(t => t.length > 0);
              if (selectedTexts.length === 0) {
                  alert('é€‰ä¸­çš„åé¦ˆæ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹');
                  return;
              }
              const text = selectedTexts.join('\n');
              const filename = `å®¢æˆ·åé¦ˆé€‰ä¸­_${new Date().toISOString().split('T')[0]}.txt`;
              downloadTextFile(filename, text);
          }
          
          // æ›´æ–°å®¢æˆ·è¯„è®º
          function updateComments() {
              const comments = filteredData
                  .filter(item => item['customer-comments'] && item['customer-comments'].trim())
                  .map(item => ({
                      date: item['return-date'],
                      asin: item.asin,
                      sku: item.sku,
                      reason: item.reason,
                      comment: item['customer-comments']
                  }));
              
              document.getElementById('commentCount').textContent = comments.length;
              
              const commentsList = document.getElementById('commentsList');
              commentsList.innerHTML = '';
              
              if (comments.length === 0) {
                  commentsList.innerHTML = '<p style="color: #666; text-align: center;">æš‚æ— å®¢æˆ·è¯„è®º</p>';
                  return;
              }
              
              currentComments = comments;
              selectedCommentIndexes.clear();
              const selectAllEl = document.getElementById('selectAllComments');
              if (selectAllEl) selectAllEl.checked = false;
              
              comments.forEach((item, idx) => {
                  const commentDiv = document.createElement('div');
                  commentDiv.className = 'comment-item';
                  
                  const date = new Date(item.date);
                  const dateStr = !isNaN(date) ? date.toLocaleDateString() : 'æœªçŸ¥æ—¥æœŸ';
                  const isoDate = !isNaN(date) ? date.toISOString().split('T')[0] : 'æœªçŸ¥æ—¥æœŸ';
                  
                  commentDiv.innerHTML = `
                      <div class="comment-meta">
                          <strong>${item.asin || 'æœªçŸ¥ASIN'}</strong> | 
                          SKU: ${item.sku || '-'} | 
                          é€€è´§åŸå› : ${item.reason || '-'} | 
                          ${dateStr}
                      </div>
                      <div style="margin-top: 8px;">${item.comment}</div>
                  `;
                  
                  const checkbox = document.createElement('input');
                  checkbox.type = 'checkbox';
                  checkbox.className = 'comment-select';
                  checkbox.style.marginTop = '10px';
                  checkbox.dataset.index = String(idx);
                  checkbox.addEventListener('change', () => {
                      const i = parseInt(checkbox.dataset.index);
                      if (!isNaN(i)) {
                          if (checkbox.checked) {
                              selectedCommentIndexes.add(i);
                          } else {
                              selectedCommentIndexes.delete(i);
                          }
                      }
                      updateSelectAllCheckbox();
                  });
                  
                  commentDiv.appendChild(checkbox);
                  commentsList.appendChild(commentDiv);
              });
          }
          
          // å¯¼å‡ºåˆ†ææŠ¥å‘Š
          function exportAnalysis() {
              const wb = XLSX.utils.book_new();
              
              // æ±‡æ€»æ•°æ®
              const summary = [
                  ['äºšé©¬é€Šé€€è´§åˆ†ææŠ¥å‘Š'],
                  ['ç”Ÿæˆæ—¶é—´', new Date().toLocaleString()],
                  ['ä½œè€…', 'é”å“¥'],
                  [''],
                  ['æ€»é€€è´§æ¬¡æ•°', document.getElementById('totalReturns').textContent],
                  ['é€€è´§å•†å“æ€»æ•°', document.getElementById('totalQuantity').textContent],
                  ['æ¶‰åŠASINæ•°', document.getElementById('totalAsins').textContent],
                  ['æ¶‰åŠSKUæ•°', document.getElementById('totalSkus').textContent],
                  ['å¹³å‡æ¯æ—¥é€€è´§', document.getElementById('avgDaily').textContent],
                  ['æœ€å¸¸è§é€€è´§åŸå› ', document.getElementById('topReason').textContent]
              ];
              
              const summarySheet = XLSX.utils.aoa_to_sheet(summary);
              XLSX.utils.book_append_sheet(wb, summarySheet, 'æ±‡æ€»');
              
              // äº§å“åˆ†ææ•°æ®
              const analysisTable = document.getElementById('analysisTable');
              const analysisSheet = XLSX.utils.table_to_sheet(analysisTable);
              XLSX.utils.book_append_sheet(wb, analysisSheet, 'äº§å“åˆ†æ');
              
              // é…é€ä¸­å¿ƒåˆ†æ
              const fcTable = document.getElementById('fcTable');
              const fcSheet = XLSX.utils.table_to_sheet(fcTable);
              XLSX.utils.book_append_sheet(wb, fcSheet, 'é…é€ä¸­å¿ƒåˆ†æ');
              
              // å®¢æˆ·è¯„è®º
              const comments = filteredData
                  .filter(item => item['customer-comments'] && item['customer-comments'].trim())
                  .map(item => ({
                      'é€€è´§æ—¥æœŸ': item['return-date'],
                      'ASIN': item.asin,
                      'SKU': item.sku,
                      'é€€è´§åŸå› ': item.reason,
                      'å®¢æˆ·è¯„è®º': item['customer-comments']
                  }));
              
              if (comments.length > 0) {
                  const commentsSheet = XLSX.utils.json_to_sheet(comments);
                  XLSX.utils.book_append_sheet(wb, commentsSheet, 'å®¢æˆ·è¯„è®º');
              }
              
              // åŸå§‹æ•°æ®
              const rawSheet = XLSX.utils.json_to_sheet(filteredData);
              XLSX.utils.book_append_sheet(wb, rawSheet, 'åŸå§‹æ•°æ®');
              
              // ä¸‹è½½æ–‡ä»¶
              XLSX.writeFile(wb, `é€€è´§åˆ†ææŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.xlsx`);
          }
          
          // ä¸‹è½½å›¾è¡¨
          function downloadCharts() {
              const chartIds = ['reasonChart', 'asinChart', 'fcChart', 'trendChart'];
              const loadPromises = chartIds.map(id => {
                  const el = document.getElementById(id);
                  return new Promise(resolve => {
                      if (!el) return resolve(null);
                      const img = new Image();
                      img.onload = () => resolve({ id, img });
                      img.src = el.toDataURL('image/png');
                  });
              });
              
              Promise.all(loadPromises).then(results => {
                  const images = results.filter(Boolean);
                  if (images.length === 0) return;
                  
                  const exportWidth = 1600; // å¯¼å‡ºå®½åº¦æ›´å¤§ï¼Œæå‡æ¸…æ™°åº¦
                  const margin = 60;
                  const gap = 40;
                  const headerTitleHeight = 32;
                  const headerSubHeight = 22;
                  const innerWidth = exportWidth - margin * 2;
                  
                  // å…ˆè®¡ç®—ç¼©æ”¾åçš„æ€»é«˜åº¦ï¼Œä¿æŒç­‰æ¯”ï¼Œä¸æ‹‰ä¼¸
                  const scaled = images.map(({ img }) => {
                      const scale = innerWidth / img.width;
                      return {
                          img,
                          w: Math.round(img.width * scale),
                          h: Math.round(img.height * scale)
                      };
                  });
                  const chartsTotalHeight = scaled.reduce((sum, s) => sum + s.h, 0) + gap * (scaled.length - 1);
                  const exportHeight = margin + headerTitleHeight + headerSubHeight + margin + chartsTotalHeight + margin;
                  
                  const canvas = document.createElement('canvas');
                  canvas.width = exportWidth;
                  canvas.height = exportHeight;
                  const ctx = canvas.getContext('2d');
                  
                  // ç™½è‰²èƒŒæ™¯
                  ctx.fillStyle = 'white';
                  ctx.fillRect(0, 0, canvas.width, canvas.height);
                  ctx.imageSmoothingEnabled = true;
                  ctx.imageSmoothingQuality = 'high';
                  
                  // æ ‡é¢˜ä¸ä½œè€…
                  ctx.fillStyle = '#232F3E';
                  ctx.textAlign = 'center';
                  ctx.font = 'bold 28px Arial';
                  ctx.fillText('äºšé©¬é€Šé€€è´§åˆ†æå›¾è¡¨', exportWidth / 2, margin + headerTitleHeight - 4);
                  ctx.fillStyle = '#666';
                  ctx.font = '16px Arial';
                  ctx.fillText('ä½œè€…ï¼šé”å“¥', exportWidth / 2, margin + headerTitleHeight + headerSubHeight);
                  
                  // ç»˜åˆ¶å›¾è¡¨ï¼ˆç­‰æ¯”ç¼©æ”¾ï¼Œæ°´å¹³å±…ä¸­ï¼‰
                  let y = margin + headerTitleHeight + headerSubHeight + margin;
                  scaled.forEach(s => {
                      const x = Math.round((exportWidth - s.w) / 2);
                      ctx.drawImage(s.img, x, y, s.w, s.h);
                      y += s.h + gap;
                  });
                  
                  // è§¦å‘ä¸‹è½½
                  const link = document.createElement('a');
                  link.download = `äºšé©¬é€Šé€€è´§åˆ†æå›¾è¡¨_${new Date().toISOString().split('T')[0]}.png`;
                  link.href = canvas.toDataURL('image/png');
                  link.click();
              });
          }
          
          // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
          window.onclick = function(event) {
              const modal = document.getElementById('helpModal');
              if (event.target === modal) {
                  modal.style.display = 'none';
              }
          }
      </script>
    <footer style="margin-top: 24px; padding: 16px; text-align: center; color: #666; font-size: 14px; background: #f9f9f9; border-top: 1px solid #eee;">
        ç‰ˆæƒå½’ è·¨å¢ƒä¹è¶£å›­æ‰€æœ‰ å®˜ç½‘ï¼š <a href="https://amzlink.top/" target="_blank" rel="noopener noreferrer">https://amzlink.top/</a> | ä½œè€…ï¼šé”å“¥
    </footer>
  </body>
  </html>
