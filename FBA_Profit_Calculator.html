<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äºšé©¬é€ŠFBAé…é€è´¹ä¸åˆ©æ¶¦è®¡ç®—ä¸€ä½“æœº (2026ç‰ˆ)</title>
  <style>
    :root {
      --primary-color: #2a5d9f;
      --bg-color: #f6f7f9;
      --card-bg: #fff;
      --border-color: #ddd;
      --text-color: #333;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
    }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: var(--bg-color); color: var(--text-color); margin: 0; }
    h2, h3 { color: var(--primary-color); margin-top: 0; }
    .container { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1400px; margin: 0 auto; }
    .card { flex: 1; min-width: 350px; background: var(--card-bg); border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .full-width { width: 100%; flex: 100%; }
    
    label { display: block; margin-top: 10px; font-weight: 500; font-size: 14px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px; }
    .row label { margin-top: 0; margin-right: 5px; }
    input[type="number"], select, input[type="text"] { padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    input[type="number"] { width: 80px; }
    
    .input-group { background: #f9f9f9; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #eee; }
    .input-group-title { font-size: 13px; font-weight: bold; color: #666; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px; }

    .result-box { background: #eef5ff; border: 1px solid #b8daff; padding: 15px; border-radius: 6px; margin-top: 15px; }
    .result-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
    .result-item.total { font-weight: bold; border-top: 1px solid #b8daff; padding-top: 5px; margin-top: 5px; font-size: 16px; }
    .profit-positive { color: var(--success-color); }
    .profit-negative { color: var(--danger-color); }
    
    button { cursor: pointer; padding: 8px 16px; background: var(--primary-color); color: #fff; border: none; border-radius: 4px; font-size: 14px; transition: background 0.2s; }
    button:hover { background: #1e4b87; }
    button.secondary { background: #6c757d; }
    button.secondary:hover { background: #5a6268; }
    
    .toggle-btn { background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); width: 100%; margin-top: 20px; }
    .toggle-btn:hover { background: #e6ecfa; }
    
    .hidden { display: none; }
    
    /* Rules Table Styles */
    table { border-collapse: collapse; width: 100%; background: #fff; margin: 10px 0 15px 0; font-size: 13px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    th { background: #e6ecfa; }
    .tab-btns { margin-bottom: 10px; }
    .tab-btns button { margin-right: 6px; padding: 4px 12px; background: #f6f7f9; border: 1px solid var(--primary-color); color: var(--primary-color); }
    .tab-btns button.active { background: var(--primary-color); color: #fff; }
    .fee-table { display: none; }
    .fee-table.active { display: block; }

    /* Slider Styles */
    .slider-container { margin-top: 10px; }
    .slider-row { display: flex; align-items: center; justify-content: space-between; font-size: 13px; margin-bottom: 5px; }
    input[type="range"] { width: 100%; cursor: pointer; }

    .emoji { font-size: 1.2em; margin-left: 5px; }
    
    .desc-text { font-size: 12px; color: #666; margin-top: 2px; }
    .highlight-input { background-color: #fffde7; border-color: #f0ad4e; }

    /* History & Chart Styles */
    .btn-sm { padding: 4px 8px; font-size: 12px; margin-right: 4px; }
    .btn-danger { background: var(--danger-color); }
    .btn-load { background: var(--success-color); }
    .chart-container { display: flex; height: 24px; border-radius: 4px; overflow: hidden; margin-bottom: 15px; background: #e0e0e0; cursor: help; }
    .chart-segment { height: 100%; transition: width 0.3s; position: relative; display: flex; align-items: center; justify-content: center; font-size: 10px; color: rgba(255,255,255,0.9); overflow: hidden; }
    .bg-cost { background: #6c757d; }
    .bg-fba { background: #17a2b8; }
    .bg-ref { background: #ffc107; color: #333; }
    .bg-ads { background: #fd7e14; }
    .bg-profit { background: #28a745; }
    .bg-loss { background: #dc3545; }
  </style>
</head>
<body>

  <div class="container">
    <!-- Left Card: Shipping Calculator -->
    <div class="card">
      <h3>ğŸ“¦ é…é€è´¹è®¡ç®— (Shipping)</h3>
      
      <div class="input-group">
        <div class="input-group-title">å•†å“ä¿¡æ¯ (Product Info)</div>
        <div class="row">
          <label style="flex:2;">åç§° (Name) <input id="productName" type="text" placeholder="ä¾‹å¦‚: iPhone 15 Case" style="width: 100%; box-sizing: border-box;"></label>
          <label style="flex:1;">å‘è´§æ•°é‡ <input id="shipmentQty" type="number" min="1" step="1" value="1" oninput="calculateAll()" style="width: 100%; box-sizing: border-box;"></label>
        </div>
      </div>

      <div class="input-group">
        <div class="input-group-title">å•†å“å°ºå¯¸ (Dimensions)</div>
        <div class="row">
          <label>é•¿ <input id="length" type="number" min="0" step="0.01" value="0"></label>
          <select id="lengthUnit"><option value="in">in</option><option value="cm">cm</option></select>
        </div>
        <div class="row">
          <label>å®½ <input id="width" type="number" min="0" step="0.01" value="0"></label>
          <select id="widthUnit"><option value="in">in</option><option value="cm">cm</option></select>
        </div>
        <div class="row">
          <label>é«˜ <input id="height" type="number" min="0" step="0.01" value="0"></label>
          <select id="heightUnit"><option value="in">in</option><option value="cm">cm</option></select>
        </div>
      </div>

      <div class="input-group">
        <div class="input-group-title">é‡é‡ (Weight)</div>
        <div class="row">
          <label>å®é‡ <input id="actualWeight" type="number" min="0" step="0.01" value="0"></label>
          <select id="weightUnit"><option value="oz">oz</option><option value="g">g</option><option value="lb">lb</option></select>
        </div>
      </div>

      <div class="input-group">
        <div class="input-group-title">å•†å“å±æ€§ (Attributes)</div>
        <div class="row">
          <label>ç±»å‹
            <select id="productType" onchange="showFeeTab(); calculateAll();">
              <option value="normal">æ™®é€š (Normal)</option>
              <option value="apparel">æœè£… (Apparel)</option>
              <option value="danger">å±é™©å“ (Dangerous)</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label><input id="hasLithium" type="checkbox" onchange="calculateAll()"> å«é”‚ç”µæ±  (Lithium)</label>
        </div>
      </div>
      
      <div class="input-group">
        <div class="input-group-title">è®¡è´¹è®¾ç½® (Settings)</div>
        <div class="row">
           <label>å”®ä»·($) <input id="priceUSD" class="highlight-input" type="number" min="0" step="0.01" value="0" oninput="syncPrice()"></label>
        </div>
        <div class="row">
          <label>å­£èŠ‚
            <select id="season" onchange="showFeeTab(); calculateAll();">
              <option value="non_peak">éæ—ºå­£</option>
              <option value="peak">æ—ºå­£</option>
            </select>
          </label>
           <label>ç‰ˆæœ¬
            <select id="version" onchange="showFeeTab(); calculateAll();">
              <option value="2025">2025</option>
              <option value="2026">2026</option>
            </select>
          </label>
        </div>
        <div class="row">
           <label><input id="autoSeason" type="checkbox" checked onchange="onAutoSeasonToggle(); calculateAll();"> è‡ªåŠ¨æŒ‰æ—¥æœŸ</label>
        </div>
        <div class="row">
          <label>é™„åŠ è´¹($) <input id="surchargeUSD" type="number" min="0" step="0.01" value="0" oninput="calculateAll()"></label>
        </div>
      </div>

      <button onclick="calculateAll()">è®¡ç®—é…é€è´¹ (Calculate Fee)</button>
      <button class="secondary" onclick="resetInputs()">é‡ç½® (Reset)</button>

      <div id="shippingResult" class="result-box" style="display:none;">
        <!-- Shipping Result Content -->
      </div>
    </div>

    <!-- Right Card: Profit Calculator -->
    <div class="card">
      <h3>ğŸ’° åˆ©æ¶¦è®¡ç®— (Profit)</h3>
      
      <div class="input-group">
        <div class="input-group-title">æ ¸å¿ƒæ•°æ® (Core Data)</div>
        <div class="row">
          <label>å”®ä»·($) <input id="profitPrice" class="highlight-input" type="number" step="0.01" value="0" oninput="syncPriceFromProfit()"></label>
          <label>æ±‡ç‡(ï¿¥/$) <input id="exchangeRate" type="number" step="0.01" value="7.2" oninput="calculateAll()"></label>
        </div>
      </div>

      <div class="input-group">
        <div class="input-group-title">æˆæœ¬ (Cost in CNY)</div>
        <div class="row">
          <label>é‡‡è´­æˆæœ¬(ï¿¥) <input id="productCostCNY" class="highlight-input" type="number" step="0.01" value="0" oninput="calculateAll()"></label>
          <label>å¤´ç¨‹è¿è´¹(ï¿¥) <input id="shippingCostCNY" class="highlight-input" type="number" step="0.01" value="0" oninput="calculateAll()"></label>
        </div>
      </div>

      <div class="input-group">
        <div class="input-group-title">äºšé©¬é€Šè´¹ç”¨ (Amazon Fees in USD)</div>
        <div class="row">
          <label>å•†å“ç±»ç›® (Category)
            <select id="categorySelect" onchange="calculateAll()" style="max-width:200px;">
              <option value="custom">-- è‡ªå®šä¹‰ (Custom) --</option>
              <!-- Populated by JS -->
            </select>
          </label>
        </div>
        <div class="row">
          <label>ä½£é‡‘è´¹($) <input id="referralFeeDisplay" type="number" step="0.01" value="0" readonly style="background:#eee; color:#555;"></label>
          <label style="margin-left:10px;">è‡ªå®šä¹‰æ¯”ä¾‹ <input id="referralRateCustom" type="number" step="0.01" value="0.15" placeholder="0.15" oninput="calculateAll()"></label>
        </div>
        <div class="row">
          <label>FBAé…é€è´¹($) <input id="fbaFeeInput" type="number" step="0.01" value="0" oninput="calculateAll()"></label>
          <span class="desc-text">(è‡ªåŠ¨è·å–/æ‰‹åŠ¨ä¿®æ”¹)</span>
        </div>
        <div class="row">
          <label>æœˆä»“å‚¨è´¹($) <input id="storageFee" type="number" step="0.01" value="0" oninput="calculateAll()"></label>
          <label>å…¶ä»–æ‚è´¹($) <input id="otherFee" type="number" step="0.01" value="0" oninput="calculateAll()"></label>
        </div>
      </div>

      <div class="input-group">
        <div class="input-group-title">è¿è¥æŒ‡æ ‡ (Operations)</div>
        <div class="row">
           <label>é€€è´§ç‡(%) <input id="returnRate" type="number" step="0.1" value="5" oninput="syncSlider('returnRate', 'returnRateSlider'); calculateAll();"></label>
           <label>ä¸å¯å”®(%) <input id="unsellableRate" type="number" step="0.1" value="0" oninput="calculateAll()"></label>
        </div>
        <div class="row">
           <label>å¹¿å‘ŠACoS(%) <input id="acos" type="number" step="0.1" value="10" oninput="syncSlider('acos', 'acosSlider'); calculateAll();"></label>
        </div>
      </div>

      <!-- Sensitivity Analysis -->
      <div class="input-group" style="background:#fffbe6; border-color:#ffe58f;">
        <div class="input-group-title" style="color:#d48806; border-color:#ffe58f;">æ•æ„Ÿæ€§åˆ†æ (Sensitivity)</div>
        <div class="slider-container">
          <div class="slider-row">
            <span>é€€è´§ç‡: <span id="returnRateDisplay">5</span>%</span>
          </div>
          <input type="range" id="returnRateSlider" min="0" max="30" step="0.5" value="5" oninput="syncInput('returnRate', 'returnRateSlider'); calculateAll();">
        </div>
        <div class="slider-container">
          <div class="slider-row">
            <span>å¹¿å‘ŠACoS: <span id="acosDisplay">10</span>%</span>
          </div>
          <input type="range" id="acosSlider" min="0" max="100" step="1" value="10" oninput="syncInput('acos', 'acosSlider'); calculateAll();">
        </div>
      </div>

      <div id="profitResult" class="result-box">
        <div id="costChart" class="chart-container" title="æˆæœ¬æ„æˆåˆ†æ (Cost Structure)"></div>
        <div class="result-item"><span>äºšé©¬é€Šå›æ¬¾ (Payout):</span> <span id="resPayout">$0.00</span></div>
        <div class="result-item"><span>æ€»æˆæœ¬ (Total Cost):</span> <span id="resTotalCost">$0.00</span></div>
        <div class="result-item"><span>æ¯›åˆ©æ¶¦ (Gross Profit):</span> <span id="resGrossProfit">$0.00</span></div>
        <div class="result-item"><span>å¹¿å‘Šè´¹ (Ads):</span> <span id="resAds">$0.00</span></div>
        <div class="result-item"><span>é€€è´§æŸå¤± (Return Loss):</span> <span id="resReturnLoss">$0.00</span></div>
        <div class="result-item total">
          <span>å‡€åˆ©æ¶¦ (Net Profit):</span> 
          <span><span id="resNetProfit">$0.00</span> <span id="profitEmoji" class="emoji"></span></span>
        </div>
        <div class="result-item"><span>å‡€åˆ©ç‡ (Margin):</span> <span id="resMargin">0.00%</span></div>
        <div class="result-item"><span>ç›ˆäºå¹³è¡¡ACoS:</span> <span id="resBreakEven">0.00%</span></div>
        <div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:5px; font-size:13px; color:#666;">
           <div>äººæ°‘å¸å‡€åˆ©æ¶¦: <span id="resNetProfitCNY">Â¥0.00</span></div>
        </div>

        <div style="margin-top:10px; background:#f0f8ff; padding:8px; border-radius:4px; border:1px solid #cce5ff;">
            <div style="font-weight:bold; color:#004085; font-size:13px; margin-bottom:5px;">ğŸ“‹ æ•´æ‰¹åˆ©æ¶¦åˆ†æ (Batch Analysis)</div>
            <div class="result-item"><span>æ€»èµ„é‡‘æŠ•å…¥ (Investment):</span> <span id="batchInvestment">Â¥0.00</span></div>
            <div class="result-item"><span>é¢„è®¡æ€»å‡€åˆ© (Total Profit):</span> <span id="batchNetProfit">Â¥0.00</span></div>
            <div class="result-item"><span>æœ€åå›æ¬¾ (Total Payout):</span> <span id="batchPayout">$0.00</span></div>
            <div class="result-item"><span>æŠ•èµ„å›æŠ¥ç‡ (ROI):</span> <span id="batchROI">0.00%</span></div>
        </div>

        <div style="margin-top:15px; display:flex; gap:10px; justify-content: flex-end;">
           <button class="secondary" onclick="copyResults()" style="flex:1;">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
           <button onclick="saveHistory()" style="flex:1;">ğŸ’¾ ä¿å­˜è®°å½•</button>
        </div>
      </div>
    </div>
  </div>

  <!-- History Section -->
  <div class="card full-width" style="max-width: 1400px; margin: 20px auto;">
    <h3>ğŸ“œ å†å²è®°å½• (History) æ³¨ï¼šå†å²è®°å½•ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œä¸ä¼šä¸Šä¼ æœåŠ¡å™¨</h3>
    <div style="max-height: 300px; overflow-y: auto;">
      <table class="history-table">
        <thead>
          <tr>
            <th>æ—¶é—´ (Time)</th>
            <th>åç§° (Name)</th>
            <th>å”®ä»· (Price)</th>
            <th>å‡€åˆ© (Profit)</th>
            <th>åˆ©æ¶¦ç‡ (Margin)</th>
            <th style="width:120px;">æ“ä½œ (Action)</th>
          </tr>
        </thead>
        <tbody id="historyList">
          <!-- Populated by JS -->
        </tbody>
      </table>
    </div>
    <div style="margin-top:10px;">
        <button class="secondary btn-sm" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è®°å½• (Clear All)</button>
    </div>
  </div>

  <button class="toggle-btn" onclick="toggleRules()">ğŸ“œ æ˜¾ç¤º/éšè— è¯¦ç»†è§„åˆ™ä¸è´¹ç‡è¡¨</button>

  <div id="rulesSection" class="hidden">
    <h2>äºšé©¬é€Šç¾å›½ç«™é…é€è´¹ç”¨ä¸å°ºå¯¸åˆ†æ®µè§„åˆ™</h2>
     <!-- è§„åˆ™ä¸è¯´æ˜åŒºå—å¼€å§‹ -->
    <div class="desc">
      <b>1. å•†å“å°ºå¯¸åˆ†æ®µå®šä¹‰</b>
      <table>
        <tr>
          <th>å•†å“å°ºå¯¸åˆ†æ®µ</th>
          <th>å‘è´§é‡é‡</th>
          <th>æœ€é•¿è¾¹</th>
          <th>æ¬¡é•¿è¾¹</th>
          <th>æœ€çŸ­è¾¹</th>
          <th>é•¿åº¦+å›´é•¿</th>
        </tr>
        <tr>
          <td>å°å·æ ‡å‡†å°ºå¯¸</td>
          <td>â‰¤16ç›å¸</td>
          <td>â‰¤15è‹±å¯¸</td>
          <td>â‰¤12è‹±å¯¸</td>
          <td>â‰¤0.75è‹±å¯¸</td>
          <td>ä¸é€‚ç”¨</td>
        </tr>
        <tr>
          <td>å¤§å·æ ‡å‡†å°ºå¯¸</td>
          <td>â‰¤20ç£…</td>
          <td>â‰¤18è‹±å¯¸</td>
          <td>â‰¤14è‹±å¯¸</td>
          <td>â‰¤8è‹±å¯¸</td>
          <td>ä¸é€‚ç”¨</td>
        </tr>
        <tr>
          <td>å°å·å¤§ä»¶</td>
          <td>â‰¤70ç£…</td>
          <td>â‰¤60è‹±å¯¸</td>
          <td>â‰¤30è‹±å¯¸</td>
          <td>ä¸é€‚ç”¨</td>
          <td>â‰¤130è‹±å¯¸</td>
        </tr>
        <tr>
          <td>ä¸­å·å¤§ä»¶</td>
          <td>â‰¤150ç£…</td>
          <td>â‰¤108è‹±å¯¸</td>
          <td>ä¸é€‚ç”¨</td>
          <td>ä¸é€‚ç”¨</td>
          <td>â‰¤130è‹±å¯¸</td>
        </tr>
        <tr>
          <td>å¤§å·å¤§ä»¶</td>
          <td>â‰¤150ç£…</td>
          <td>â‰¤108è‹±å¯¸</td>
          <td>ä¸é€‚ç”¨</td>
          <td>ä¸é€‚ç”¨</td>
          <td>â‰¤165è‹±å¯¸</td>
        </tr>
        <tr>
          <td>ç‰¹æ®Šå¤§ä»¶</td>
          <td>è¶…è¿‡150ç£…</td>
          <td>è¶…è¿‡108è‹±å¯¸</td>
          <td>ä¸é€‚ç”¨</td>
          <td>ä¸é€‚ç”¨</td>
          <td>è¶…è¿‡165è‹±å¯¸</td>
        </tr>
      </table>
      <ul style="margin-left:18px;">
        <li>å‘è´§é‡é‡ä¸ºå•†å“é‡é‡æˆ–ä½“ç§¯é‡é‡ä¸­çš„è¾ƒå¤§å€¼ï¼Œç”¨äºç¡®å®šå°ºå¯¸åˆ†æ®µã€‚</li>
        <li>å¯¹äºå¤§å·æ ‡å‡†å°ºå¯¸ã€å¤§å·å¤§ä»¶å’Œè¶…å¤§ä»¶ï¼ˆ150ç£…ä»¥ä¸‹ï¼‰ï¼Œäºšé©¬é€Šä½¿ç”¨ä½“ç§¯é‡é‡è®¡è´¹ï¼ˆå¦‚æœä½“ç§¯é‡é‡&gt;å•†å“é‡é‡ï¼‰ã€‚</li>
        <li>å¯¹äºå°å·æ ‡å‡†å°ºå¯¸ã€è¶…å¤§ä»¶ï¼ˆ150ç£…åŠä»¥ä¸Šï¼‰ï¼Œä»…ä½¿ç”¨å•†å“é‡é‡è®¡è´¹ã€‚</li>
        <li>ä½“ç§¯é‡é‡è®¡ç®—å…¬å¼ï¼š<b>ä½“ç§¯é‡é‡(ç£…) = (é•¿xå®½xé«˜ï¼Œå•ä½è‹±å¯¸) Ã· 139</b>ï¼Œå®½å’Œé«˜æœ€å°å–2è‹±å¯¸ã€‚</li>
      </ul>
  
      <b>2. é…é€è´¹ç”¨åˆ†æ®µ</b>
      <div class="tab-btns">
        <button type="button" class="active" onclick="switchTab('normal')">æ™®é€šå•†å“</button>
        <button type="button" onclick="switchTab('apparel')">æœè£…</button>
        <button type="button" onclick="switchTab('danger')">å±é™©å“</button>
        <button type="button" onclick="downloadCurrentTable()" style="background:#28a745;color:#fff;border-color:#28a745;margin-left:10px;">ğŸ“¥ ä¸‹è½½å½“å‰è¡¨æ ¼</button>
      </div>
      <div class="row" style="margin:6px 0 8px 0;">
        <label style="display:inline-block;margin-right:12px;">å­£èŠ‚:
          <select id="tableSeason" onchange="onTableSeasonChange(this)">
            <option value="non_peak">éæ—ºå­£</option>
            <option value="peak">æ—ºå­£</option>
          </select>
        </label>
        <label class="unit" style="display:inline-block;margin-right:12px;">è®¡è´¹ç‰ˆæœ¬:
          <select id="tableVersion" onchange="onTableVersionChange(this)">
            <option value="2025">2025</option>
            <option value="2026">2026</option>
          </select>
        </label>
        <label class="unit" style="display:inline-block;">è‡ªåŠ¨æŒ‰æ—¥æœŸ:
          <input id="tableAutoSeason" type="checkbox" checked onchange="onTableAutoSeasonToggle()">
        </label>
      </div>
      <div id="fee-normal" class="fee-table active"></div>
      <div id="fee-apparel" class="fee-table"></div>
      <div id="fee-danger" class="fee-table"></div>
      <ul style="margin-left:18px;">
        <li>æœè£…ç±»å•†å“ã€å±é™©å“å•†å“é…é€è´¹ç”¨ä¸æ™®é€šå•†å“æœ‰æ‰€ä¸åŒï¼Œå…·ä½“è§ä¸Šè¡¨ã€‚</li>
        <li>æ‰€æœ‰è´¹ç”¨æŒ‰å‘è´§é‡é‡è®¡è´¹ï¼Œå‘è´§é‡é‡ä¸ºå®é™…é‡é‡å’Œä½“ç§¯é‡é‡ä¸­çš„è¾ƒå¤§å€¼ã€‚</li>
      </ul>

      <div style="margin-top: 15px;"></div>
      <b>3. å¸¸è§é—®é¢˜ï¼š</b> 
      <ul style="margin-left:18px;"> 
        <li><b>å•†å“é‡é‡</b> ï¼šæŒ‡å•†å“å®Œå…¨åŒ…è£…åçš„å®é™…ç§°é‡é‡é‡ã€‚</li> 
        <li><b>ä½“ç§¯é‡é‡</b> ï¼šæ ¹æ®å•†å“å°ºå¯¸ä¼°ç®—çš„é‡é‡ï¼Œé€‚ç”¨å¤§å·æ ‡å‡†å°ºå¯¸ã€å¤§å·å¤§ä»¶ã€è¶…å¤§ä»¶ï¼ˆ150ç£…ä»¥ä¸‹ï¼‰ã€‚</li> 
        <li>å‘è´§é‡é‡å–å•†å“é‡é‡ä¸ä½“ç§¯é‡é‡ä¸­çš„è¾ƒå¤§å€¼ï¼Œç¡®å®šæœ€ç»ˆè´¹ç”¨åˆ†æ®µã€‚</li> 
      </ul>

      <b>4. ç¤ºä¾‹ï¼š</b> 
      <ul style="margin-left:18px;"> 
        <li><b>ç§»åŠ¨è®¾å¤‡å£³</b>ï¼š13.8Ã—9Ã—0.7è‹±å¯¸ï¼Œ2.88ç›å¸ â†’ åˆ†æ®µï¼šå°å·æ ‡å‡†å°ºå¯¸</li> 
        <li><b>Tæ¤</b>ï¼š8.5Ã—4.8Ã—1è‹±å¯¸ï¼Œ6.08ç›å¸ â†’ åˆ†æ®µï¼šå¤§å·æ ‡å‡†å°ºå¯¸ï¼ˆæœè£…ï¼‰</li> 
        <li><b>å©´å„¿åºŠ</b>ï¼š24Ã—7.5Ã—6è‹±å¯¸ï¼Œ7.9ç£… â†’ åˆ†æ®µï¼šå¤§å·å¤§ä»¶</li> 
        <li><b>æ˜¾ç¤ºå™¨</b>ï¼š54Ã—35Ã—3.5è‹±å¯¸ï¼Œä½“ç§¯é‡é‡47.59ç£… â†’ åˆ†æ®µï¼šè¶…å¤§ä»¶</li> 
        <li><b>æ¶ˆæ¯’æ¶²</b>ï¼š12Ã—6Ã—3è‹±å¯¸ï¼Œ2ç£… â†’ åˆ†æ®µï¼šå¤§å·æ ‡å‡†å°ºå¯¸ï¼ˆå±é™©å“ï¼‰</li>
      </ul>

      <b>5. åˆ©æ¶¦è®¡ç®—é€»è¾‘è¯´æ˜</b>
      <ul style="margin-left:18px;">
        <li><b>äºšé©¬é€Šå›æ¬¾ (Payout)</b> = å”®ä»· - ä½£é‡‘ - FBAé…é€è´¹</li>
        <li><b>æ€»æˆæœ¬</b> = (é‡‡è´­æˆæœ¬ + å¤´ç¨‹è¿è´¹) Ã· æ±‡ç‡</li>
        <li><b>é€€è´§æŸå¤±</b> = (å”®ä»· + FBAé…é€è´¹) Ã— é€€è´§ç‡ Ã— ä¸å¯å”®æ¯”ä¾‹ + é€€æ¬¾ç®¡ç†è´¹ Ã— é€€è´§ç‡</li>
        <li><b>å¹¿å‘Šè´¹</b> = å”®ä»· Ã— ACoS</li>
        <li><b>å‡€åˆ©æ¶¦</b> = äºšé©¬é€Šå›æ¬¾ - æ€»æˆæœ¬ - å¹¿å‘Šè´¹ - é€€è´§æŸå¤± - æœˆä»“å‚¨è´¹ - å…¶ä»–æ‚è´¹</li>
        <li><b>ç›ˆäºå¹³è¡¡ACoS</b> = (å‡€åˆ©æ¶¦ + å¹¿å‘Šè´¹) Ã· å”®ä»·</li>
      </ul>

      <div style="margin-top: 15px;"></div>
      <b>6. é”€å”®ä½£é‡‘è´¹ç‡è¡¨</b>
      <table>
        <tr>
          <th>ä½£é‡‘åˆ†ç±»</th>
          <th>é”€å”®ä½£é‡‘ç™¾åˆ†æ¯”</th>
          <th>æœ€ä½é”€å”®ä½£é‡‘</th>
        </tr>
        <tr><td>äºšé©¬é€Šè®¾å¤‡é…ä»¶</td><td>45%</td><td>$0.30</td></tr>
        <tr><td>æ±½è½¦å’Œæˆ·å¤–åŠ¨åŠ›è®¾å¤‡</td><td>12%</td><td>$0.30</td></tr>
        <tr><td>æ¯å©´</td><td>æ€»å”®ä»·â‰¤$10: 8%<br>æ€»å”®ä»·>$10: 15%</td><td>$0.30</td></tr>
        <tr><td>èƒŒåŒ…ã€æ‰‹æåŒ…å’Œç®±åŒ…</td><td>15%</td><td>$0.30</td></tr>
        <tr><td>åŸºç¡€è®¾å¤‡ç”µåŠ¨å·¥å…·</td><td>12%</td><td>$0.30</td></tr>
        <tr><td>ç¾å¦†å’Œä¸ªæŠ¤å¥åº·</td><td>æ€»å”®ä»·â‰¤$10: 8%<br>æ€»å”®ä»·>$10: 15%</td><td>$0.30</td></tr>
        <tr><td>å•†ä¸šã€å·¥ä¸šä¸ç§‘å­¦ç”¨å“</td><td>12%</td><td>$0.30</td></tr>
        <tr><td>æœè£…å’Œé…é¥°</td><td>æ€»å”®ä»·â‰¤$15: 5%<br>$15&lt;æ€»å”®ä»·â‰¤$20: 10%<br>æ€»å”®ä»·>$20: 17%</td><td>$0.30</td></tr>
        <tr><td>å°å‹ç”µå™¨</td><td>æ€»å”®ä»·â‰¤$300éƒ¨åˆ†: 15%<br>æ€»å”®ä»·>$300éƒ¨åˆ†: 8%</td><td>$0.30</td></tr>
        <tr><td>ç”µè„‘</td><td>8%</td><td>$0.30</td></tr>
        <tr><td>æ¶ˆè´¹ç±»ç”µå­äº§å“</td><td>8%</td><td>$0.30</td></tr>
        <tr><td>ç”µå­äº§å“é…ä»¶</td><td>æ€»å”®ä»·â‰¤$100éƒ¨åˆ†: 15%<br>æ€»å”®ä»·>$100éƒ¨åˆ†: 8%</td><td>$0.30</td></tr>
        <tr><td>å…¶ä»–</td><td>15%</td><td>$0.30</td></tr>
        <tr><td>çœ¼é•œ</td><td>15%</td><td>$0.30</td></tr>
        <tr><td>è‰ºæœ¯å“</td><td>æ€»å”®ä»·â‰¤$100éƒ¨åˆ†: 20%<br>$100&lt;æ€»å”®ä»·â‰¤$1000éƒ¨åˆ†: 15%<br>$1000&lt;æ€»å”®ä»·â‰¤$5000éƒ¨åˆ†: 10%<br>æ€»å”®ä»·>$5000éƒ¨åˆ†: 5%</td><td>--</td></tr>
        <tr><td>é‹é´</td><td>15%</td><td>$0.30</td></tr>
        <tr><td>å…¨å°ºå¯¸ç”µå™¨</td><td>8%</td><td>$0.30</td></tr>
        <tr><td>å®¶å…·</td><td>æ€»å”®ä»·â‰¤$200éƒ¨åˆ†: 15%<br>æ€»å”®ä»·>$200éƒ¨åˆ†: 10%</td><td>$0.30</td></tr>
        <tr><td>ç¤¼å“å¡</td><td>20%</td><td>--</td></tr>
        <tr><td>é£Ÿå“</td><td>æ€»å”®ä»·â‰¤$15: 8%<br>æ€»å”®ä»·>$15: 15%</td><td>--</td></tr>
        <tr><td>å®¶å±…åŠå¨æˆ¿ç”¨å“</td><td>15%</td><td>$0.30</td></tr>
        <tr><td>ç å®é¦–é¥°</td><td>æ€»å”®ä»·â‰¤$250éƒ¨åˆ†: 20%<br>æ€»å”®ä»·>$250éƒ¨åˆ†: 5%</td><td>$0.30</td></tr>
        <tr><td>è‰åªå’Œå›­è‰º</td><td>15%</td><td>$0.30</td></tr>
        <tr><td>å‰²è‰æœºå’Œé™¤é›ªæœº</td><td>æ€»å”®ä»·â‰¤$500: 15%<br>æ€»å”®ä»·>$500: 8%</td><td>$0.30</td></tr>
        <tr><td>åºŠå«</td><td>15%</td><td>$0.30</td></tr>
        <tr><td>åª’ä»‹ç±»å•†å“</td><td>15%</td><td>--</td></tr>
        <tr><td>ä¹å™¨å’Œå½±éŸ³åˆ¶ä½œ</td><td>15%</td><td>$0.30</td></tr>
        <tr><td>åŠå…¬ç”¨å“</td><td>15%</td><td>$0.30</td></tr>
        <tr><td>å® ç‰©ç”¨å“</td><td>15% (å¤„æ–¹é¥²ç²® 22%)</td><td>$0.30</td></tr>
        <tr><td>è¿åŠ¨æˆ·å¤–</td><td>15%</td><td>$0.30</td></tr>
        <tr><td>è½®èƒ</td><td>10%</td><td>$0.30</td></tr>
        <tr><td>å·¥å…·å’Œå®¶å±…è£…ä¿®</td><td>15%</td><td>$0.30</td></tr>
        <tr><td>ç©å…·å’Œæ¸¸æˆ</td><td>15%</td><td>$0.30</td></tr>
        <tr><td>è§†é¢‘æ¸¸æˆæœº</td><td>8%</td><td>--</td></tr>
        <tr><td>è§†é¢‘æ¸¸æˆå’Œæ¸¸æˆé…ä»¶</td><td>15%</td><td>--</td></tr>
        <tr><td>é’Ÿè¡¨</td><td>æ€»å”®ä»·â‰¤$1500éƒ¨åˆ†: 16%<br>æ€»å”®ä»·>$1500éƒ¨åˆ†: 3%</td><td>$0.30</td></tr>
      </table>
      <div class="desc-text" style="margin-top:5px;">
        <b>å¤‡æ³¨:</b>
        <ul style="margin-left:18px;">
          <li>åŒ…å«ç›¸æœºè®¾å¤‡å’Œé…ä»¶å•†å“çš„æ†ç»‘å•†å“è¢«å½’ç±»ä¸ºâ€œç”µå­äº§å“é…ä»¶â€åˆ†ç±»ã€‚</li>
          <li>æŸäº›æ‰‹æœºè®¾å¤‡å¯èƒ½éœ€è¦è·å¾—æ‰¹å‡†ã€‚</li>
          <li>å¦‚æœå•†å“æ— æ³•æ˜ç¡®å½’å…¥ä»»ä½•ç°æœ‰çš„åˆ†ç±»ï¼Œå¯ä½¿ç”¨â€œå…¶ä»–â€åˆ†ç±»ã€‚</li>
          <li>é€‚ç”¨äºé€šè¿‡äºšé©¬é€Šæœ¬åœ°é”€å”®æä¾›çš„æœåŠ¡ã€‚</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // --- Shipping Calculation Logic (Ported) ---
    function cmToInch(cm) { return cm / 2.54; }
    function gToOz(g) { return g / 28.3495; }
    function ozToLb(oz) { return oz / 16; }
    function lbToOz(lb) { return lb * 16; }
    function round2(x) { return Math.round(x * 100) / 100; }

    const feeData = {
      normal: {
        non_peak_2025: {
          small_standard: { steps: [2,4,6,8,10,12,14,16], lt10: [2.29,2.38,2.47,2.56,2.66,2.76,2.83,2.88], mid: [3.06,3.15,3.24,3.33,3.43,3.53,3.60,3.65], high: [3.06,3.15,3.24,3.33,3.43,3.53,3.60,3.65] },
          large_standard: { pre3_steps_oz: [4,8,12,16,20,24,28,32,36,40,44,48], lt10_pre3: [2.91,3.13,3.38,3.78,4.22,4.60,4.75,5.00,5.10,5.28,5.44,5.85], mid_pre3: [3.68,3.90,4.15,4.55,4.99,5.37,5.52,5.77,5.87,6.05,6.21,6.62], high_pre3: [3.68,3.90,4.15,4.55,4.99,5.37,5.52,5.77,5.87,6.05,6.21,6.62], post3_base: { lt10: 6.15, mid: 6.92, high: 6.92 }, post3_increment_per_4oz: 0.08 },
          small_oversize_0_50: { base: { lt10: 8.84, mid: 9.61, high: 9.61 }, per_lb: 0.38 },
          large_oversize_0_50: { base: { lt10: 8.84, mid: 9.61, high: 9.61 }, per_lb: 0.38 },
          super_oversize_0_50: { base: { lt10: 25.56, mid: 26.33, high: 26.33 }, per_lb: 0.38 },
          super_oversize_50_70: { base: { lt10: 39.35, mid: 40.12, high: 40.12 }, start_lb: 50, per_lb: 0.75 },
          super_oversize_70_150: { base: { lt10: 54.04, mid: 54.81, high: 54.81 }, start_lb: 71, per_lb: 0.75 },
          super_oversize_gt_150: { base: { lt10: 194.18, mid: 194.95, high: 194.95 }, start_lb: 151, per_lb: 0.19 }
        },
        non_peak_2026: {
          small_standard: { steps: [2,4,6,8,10,12,14,16], lt10: [2.43,2.49,2.56,2.66,2.77,2.82,2.92,2.95], mid: [3.32,3.42,3.45,3.54,3.68,3.78,3.91,3.96], high: [3.58,3.68,3.71,3.80,3.94,4.04,4.17,4.22] },
          large_standard: { pre3_steps_oz: [4,8,12,16,20,24,28,32,36,40,44,48], lt10_pre3: [2.91,3.13,3.38,3.78,4.22,4.60,4.75,5.00,5.10,5.28,5.44,5.85], mid_pre3: [3.73,3.95,4.20,4.60,5.04,5.42,5.57,5.82,5.92,6.10,6.26,6.67], high_pre3: [3.99,4.21,4.46,4.86,5.30,5.68,5.83,6.08,6.18,6.36,6.52,6.93], post3_base: { lt10: 6.15, mid: 6.97, high: 7.23 }, post3_increment_per_4oz: 0.08 },
          small_oversize_0_50: { base: { lt10: 6.78, mid: 7.55, high: 7.55 }, per_lb: 0.38 },
          large_oversize_0_50: { base: { lt10: 8.58, mid: 9.35, high: 9.35 }, per_lb: 0.38 },
          super_oversize_0_50: { base: { lt10: 25.56, mid: 26.33, high: 26.33 }, per_lb: 0.38 },
          super_oversize_50_70: { base: { lt10: 36.55, mid: 37.32, high: 37.32 }, start_lb: 50, per_lb: 0.75 },
          super_oversize_70_150: { base: { lt10: 50.55, mid: 51.32, high: 51.32 }, start_lb: 71, per_lb: 0.75 },
          super_oversize_gt_150: { base: { lt10: 194.18, mid: 194.95, high: 194.95 }, start_lb: 151, per_lb: 0.19 }
        },
        peak_2025: {
          small_standard: { steps: [2,4,6,8,10,12,14,16], lt10: [2.48,2.57,2.67,2.76,2.87,2.97,3.05,3.10], mid: [3.25,3.34,3.44,3.53,3.64,3.74,3.82,3.87], high: [3.25,3.34,3.44,3.53,3.64,3.74,3.82,3.87] },
          large_standard: { pre3_steps_oz: [4,8,12,16,20,24,28,32,36,40,44,48], lt10_pre3: [3.15,3.39,3.66,4.07,4.52,4.91,5.07,5.33,5.47,5.67,5.84,6.26], mid_pre3: [3.92,4.16,4.43,4.84,5.29,5.68,5.84,6.10,6.24,6.44,6.61,7.03], high_pre3: [3.92,4.16,4.43,4.84,5.29,5.68,5.84,6.10,6.24,6.44,6.61,7.03], post3_base: { lt10: 6.69, mid: 7.46, high: 7.46 }, post3_increment_per_4oz: 0.08 },
          small_oversize_0_50: { base: { lt10: 9.88, mid: 10.65, high: 10.65 }, per_lb: 0.38 },
          large_oversize_0_50: { base: { lt10: 9.88, mid: 10.65, high: 10.65 }, per_lb: 0.38 },
          super_oversize_0_50: { base: { lt10: 28.29, mid: 29.06, high: 29.06 }, per_lb: 0.38 },
          super_oversize_50_70: { base: { lt10: 42.16, mid: 42.93, high: 42.93 }, start_lb: 50, per_lb: 0.75 },
          super_oversize_70_150: { base: { lt10: 58.46, mid: 59.23, high: 59.23 }, start_lb: 71, per_lb: 0.75 },
          super_oversize_gt_150: { base: { lt10: 202.69, mid: 203.46, high: 203.46 }, start_lb: 151, per_lb: 0.19 }
        }
      },
      apparel: {
        non_peak_2025: {
          small_standard: { steps: [2,4,6,8,10,12,14,16], lt10: [2.50,2.50,2.65,2.65,2.95,2.95,3.21,3.21], mid: [3.27,3.27,3.42,3.42,3.72,3.72,3.98,3.98], high: [3.27,3.27,3.42,3.42,3.72,3.72,3.98,3.98] },
          large_standard: { pre3_steps_oz: [4,8,12,16,24,32,40,48], lt10_pre3: [3.48,3.68,3.90,4.35,5.13,5.13,5.37,5.37], mid_pre3: [4.25,4.45,4.67,5.12,5.90,5.90,6.14,6.14], high_pre3: [4.25,4.45,4.67,5.12,5.90,5.90,6.14,6.14], post3_base: { lt10: 6.82, mid: 6.97, high: 7.63 }, post3_increment_per_half_lb: 0.16 },
          small_oversize_0_50: { base: { lt10: 8.84, mid: 9.61, high: 9.61 }, per_lb: 0.38 },
          large_oversize_0_50: { base: { lt10: 8.84, mid: 9.61, high: 9.61 }, per_lb: 0.38 },
          super_oversize_0_50: { base: { lt10: 25.56, mid: 26.33, high: 26.33 }, per_lb: 0.38 },
          super_oversize_50_70: { base: { lt10: 39.35, mid: 40.12, high: 40.12 }, start_lb: 51, per_lb: 0.75 },
          super_oversize_70_150: { base: { lt10: 54.04, mid: 54.81, high: 54.81 }, start_lb: 71, per_lb: 0.75 },
          super_oversize_gt_150: { base: { lt10: 194.18, mid: 194.95, high: 194.95 }, start_lb: 151, per_lb: 0.19 }
        },
        non_peak_2026: {
          small_standard: { steps: [2,4,6,8,10,12,14,16], lt10: [2.62,2.64,2.68,2.81,3.00,3.10,3.20,3.30], mid: [3.51,3.54,3.59,3.69,3.91,4.09,4.20,4.25], high: [3.77,3.80,3.85,3.95,4.17,4.35,4.46,4.51] },
          large_standard: { pre3_steps_oz: [4,8,12,16,24,32,40,48], lt10_pre3: [3.48,3.68,3.90,4.35,5.05,5.22,5.32,5.43], mid_pre3: [4.30,4.50,4.72,5.17,5.87,6.04,6.14,6.25], high_pre3: [4.56,4.76,4.98,5.43,6.13,6.30,6.40,6.51], post3_base: { lt10: 6.78, mid: 6.97, high: 7.55 }, post3_increment_per_half_lb: 0.16 },
          small_oversize_0_50: { base: { lt10: 8.84, mid: 9.61, high: 9.61 }, per_lb: 0.38 },
          large_oversize_0_50: { base: { lt10: 8.58, mid: 9.35, high: 9.35 }, per_lb: 0.38 },
          super_oversize_0_50: { base: { lt10: 25.56, mid: 26.33, high: 26.33 }, per_lb: 0.38 },
          super_oversize_50_70: { base: { lt10: 36.55, mid: 37.32, high: 37.32 }, start_lb: 51, per_lb: 0.75 },
          super_oversize_70_150: { base: { lt10: 50.55, mid: 51.32, high: 51.32 }, start_lb: 71, per_lb: 0.75 },
          super_oversize_gt_150: { base: { lt10: 194.18, mid: 194.95, high: 194.95 }, start_lb: 151, per_lb: 0.19 }
        },
        peak_2025: {
          small_standard: { steps: [2,4,6,8,10,12,14,16], lt10: [2.73,2.73,2.90,2.90,3.22,3.22,3.50,3.50], mid: [3.50,3.50,3.67,3.67,3.99,3.99,4.27,4.27], high: [3.50,3.50,3.67,3.67,3.99,3.99,4.27,4.27] },
          large_standard: { pre3_steps_oz: [4,8,12,16,20,24,28,32,36,40,44,48], lt10_pre3: [3.79,4.00,4.23,4.69,5.50,5.50,5.76,5.76,6.27,6.27,6.50,6.50], mid_pre3: [4.56,4.77,5.00,5.46,6.27,6.27,6.53,6.53,7.04,7.04,7.27,7.27], high_pre3: [4.56,4.77,5.00,5.46,6.27,6.27,6.53,6.53,7.04,7.04,7.27,7.27], post3_base: { lt10: 6.82, mid: 7.59, high: 7.59 }, post3_increment_per_half_lb: 0.16 },
          small_oversize_0_50: { base: { lt10: 9.88, mid: 10.65, high: 10.65 }, per_lb: 0.38 },
          large_oversize_0_50: { base: { lt10: 9.88, mid: 10.65, high: 10.65 }, per_lb: 0.38 },
          super_oversize_0_50: { base: { lt10: 28.29, mid: 29.06, high: 29.06 }, per_lb: 0.38 },
          super_oversize_50_70: { base: { lt10: 42.16, mid: 42.93, high: 42.93 }, start_lb: 51, per_lb: 0.75 },
          super_oversize_70_150: { base: { lt10: 58.46, mid: 59.23, high: 59.23 }, start_lb: 71, per_lb: 0.75 },
          super_oversize_gt_150: { base: { lt10: 202.69, mid: 203.46, high: 203.46 }, start_lb: 151, per_lb: 0.19 }
        }
      },
      danger: {
        non_peak_2025: {
          small_standard: { steps: [2,4,6,8,10,12,14,16], lt10: [3.26,3.32,3.39,3.45,3.53,3.59,3.64,3.64], mid: [4.03,4.09,4.16,4.22,4.30,4.36,4.41,4.41], high: [4.03,4.09,4.16,4.22,4.30,4.36,4.41,4.41] },
          large_standard: { pre3_steps_oz: [20,24,28,32,36,40,44,48], lt10_pre3: [4.82,5.20,5.35,5.49,5.56,5.74,5.90,6.31], mid_pre3: [5.59,5.97,6.12,6.26,6.33,6.51,6.67,7.08], high_pre3: [5.59,5.97,6.12,6.26,6.33,6.51,6.67,7.08], post3_base: { lt10: 6.61, mid: 7.38, high: 7.38 }, post3_increment_per_4oz: 0.08 },
          small_oversize_0_50: { base: { lt10: 9.56, mid: 10.33, high: 10.33 }, per_lb: 0.38 },
          large_oversize_0_50: { base: { lt10: 9.56, mid: 10.33, high: 10.33 }, per_lb: 0.38 },
          super_oversize_0_50: { base: { lt10: 27.67, mid: 28.44, high: 28.44 }, per_lb: 0.38 },
          super_oversize_50_70: { base: { lt10: 42.56, mid: 43.33, high: 43.33 }, start_lb: 50, per_lb: 0.75 },
          super_oversize_70_150: { base: { lt10: 61.17, mid: 61.94, high: 61.94 }, start_lb: 71, per_lb: 0.75 },
          super_oversize_gt_150: { base: { lt10: 218.76, mid: 219.53, high: 219.53 }, start_lb: 151, per_lb: 0.19 }
        },
        non_peak_2026: {
          small_standard: { steps: [2,4,6,8,10,12,14,16], lt10: [3.40,3.43,3.48,3.55,3.64,3.65,3.73,3.73], mid: [4.29,4.36,4.37,4.43,4.55,4.61,4.72,4.72], high: [4.55,4.62,4.63,4.69,4.81,4.87,4.98,4.98] },
          large_standard: { pre3_steps_oz: [20,24,28,32,36,40,44,48], lt10_pre3: [4.82,5.20,5.35,5.49,5.56,5.74,5.90,6.31], mid_pre3: [5.64,6.02,6.17,6.31,6.38,6.56,6.72,7.13], high_pre3: [5.90,6.28,6.43,6.57,6.64,6.82,6.98,7.39], post3_base: { lt10: 6.61, mid: 7.43, high: 7.69 }, post3_increment_per_4oz: 0.08 },
          small_oversize_0_50: { base: { lt10: 7.5, mid: 8.27, high: 8.27 }, per_lb: 0.38 },
          large_oversize_0_50: { base: { lt10: 9.3, mid: 10.07, high: 10.07 }, per_lb: 0.38 },
          super_oversize_0_50: { base: { lt10: 27.67, mid: 28.44, high: 28.44 }, per_lb: 0.38 },
          super_oversize_50_70: { base: { lt10: 39.76, mid: 40.53, high: 40.53 }, start_lb: 50, per_lb: 0.75 },
          super_oversize_70_150: { base: { lt10: 57.68, mid: 58.45, high: 58.45 }, start_lb: 71, per_lb: 0.75 },
          super_oversize_gt_150: { base: { lt10: 218.76, mid: 219.53, high: 219.53 }, start_lb: 151, per_lb: 0.19 }
        },
        peak_2025: {
          small_standard: { steps: [2,4,6,8,10,12,14,16], lt10: [3.60,3.69,3.79,3.88,3.99,4.08,4.16,4.25], mid: [4.37,4.46,4.56,4.65,4.76,4.85,4.93,5.02], high: [4.37,4.46,4.56,4.65,4.76,4.85,4.93,5.02] },
          large_standard: { pre3_steps_oz: [4,8,12,16,20,24,28,32,36,40,44,48], lt10_pre3: [4.32,4.56,4.82,5.04,5.51,5.91,6.08,6.24,6.33,6.53,6.70,7.12], mid_pre3: [5.09,5.33,5.59,5.81,6.28,6.68,6.85,7.01,7.10,7.30,7.47,7.89], high_pre3: [5.09,5.33,5.59,5.81,6.28,6.68,6.85,7.01,7.10,7.30,7.47,7.89], post3_base: { lt10: 7.51, mid: 8.28, high: 8.28 }, post3_increment_per_4oz: 0.08 },
          small_oversize_0_50: { base: { lt10: 11.12, mid: 11.89, high: 11.89 }, per_lb: 0.38 },
          large_oversize_0_50: { base: { lt10: 11.12, mid: 11.89, high: 11.89 }, per_lb: 0.38 },
          super_oversize_0_50: { base: { lt10: 31.71, mid: 32.48, high: 32.48 }, per_lb: 0.38 },
          super_oversize_50_70: { base: { lt10: 46.66, mid: 47.43, high: 47.43 }, start_lb: 50, per_lb: 0.75 },
          super_oversize_70_150: { base: { lt10: 67.53, mid: 68.30, high: 68.30 }, start_lb: 71, per_lb: 0.75 },
          super_oversize_gt_150: { base: { lt10: 230.84, mid: 231.61, high: 231.61 }, start_lb: 151, per_lb: 0.19 }
        }
      }
    };

    function sort3(a, b, c) {
      let arr = [a, b, c].sort((x, y) => y - x);
      return { l: arr[0], w: arr[1], h: arr[2] };
    }

    function getTier(l, w, h, shipWeightOz) {
      const { l: L, w: W, h: H } = sort3(l, w, h);
      const sum = L + 2 * W + 2 * H;
      if (shipWeightOz <= 16 && L <= 15 && W <= 12 && H <= 0.75) return "å°å·æ ‡å‡†å°ºå¯¸";
      if (shipWeightOz <= 320 && L <= 18 && W <= 14 && H <= 8) return "å¤§å·æ ‡å‡†å°ºå¯¸";
      const weightLb = shipWeightOz / 16;
      if (weightLb > 150 || L > 108 || sum > 165) return "è¶…å¤§ä»¶";
      if (weightLb <= 70 && L <= 60 && W <= 30 && sum <= 130) return "å°å·å¤§ä»¶";
      if (weightLb <= 50 && L <= 108 && sum <= 165) return "å¤§å·å¤§ä»¶";
      return "è¶…å¤§ä»¶";
    }

    function getVolumeWeight(l, w, h) {
      let _w = Math.max(w, 2);
      let _h = Math.max(h, 2);
      let volumeLb = (l * _w * _h) / 139;
      if (volumeLb < 0) volumeLb = 0;
      return volumeLb;
    }

    function getPriceBand(price) { if (price < 10) return 'lt10'; if (price <= 50) return 'mid'; return 'high'; }
    function getSeasonKey() { const s = document.getElementById('season').value; const v = document.getElementById('version').value; if (s === 'peak') return 'peak_2025'; return v === '2026' ? 'non_peak_2026' : 'non_peak_2025'; }
    function autoDetectSeasonVersion() { const now = new Date(); const y = now.getFullYear(); const m = now.getMonth() + 1; const d = now.getDate(); const toNum = (yy,mm,dd) => yy * 10000 + mm * 100 + dd; const cur = toNum(y,m,d); const inRange = (sY,sM,sD,eY,eM,eD) => { const s = toNum(sY,sM,sD); const e = toNum(eY,eM,eD); return cur >= s && cur <= e; }; let season = 'non_peak'; let version = '2025'; if (inRange(2025,10,15,2026,1,14)) { season = 'peak'; version = '2025'; } else if (toNum(y,m,d) >= toNum(2026,1,15)) { season = 'non_peak'; version = '2026'; } else { season = 'non_peak'; version = '2025'; } document.getElementById('season').value = season; document.getElementById('version').value = version; renderCurrentFeeTable(); }
    
    function getFee(productType, tier, shipWeightOz, price) {
      const seasonKey = getSeasonKey();
      const dataset = feeData[productType][seasonKey];
      if (!dataset) return 'N/A';
      const band = getPriceBand(price);
      const weightLb = shipWeightOz / 16;
      if (tier === 'å°å·æ ‡å‡†å°ºå¯¸') {
        const steps = dataset.small_standard.steps;
        const fees = dataset.small_standard[band];
        for (let i = 0; i < steps.length; i++) { if (shipWeightOz <= steps[i]) return fees[i]; } // return number directly
        return 'N/A';
      }
      if (tier === 'å¤§å·æ ‡å‡†å°ºå¯¸') {
        const ls = dataset.large_standard;
        const steps = ls.pre3_steps_oz;
        const fees = ls[band + '_pre3'];
        for (let i = 0; i < steps.length; i++) { if (shipWeightOz <= steps[i]) return fees[i]; }
        if (productType === 'apparel') {
          if (weightLb > 3) { const base = ls.post3_base[band]; const extra = Math.ceil((shipWeightOz - 48) / 8) * (ls.post3_increment_per_half_lb || 0); return base + extra; }
        } else {
          if (weightLb > 3) { const base = ls.post3_base[band]; const extra = Math.ceil((shipWeightOz - 48) / 4) * (ls.post3_increment_per_4oz || 0); return base + extra; }
        }
        return 'N/A';
      }
      if (tier === 'å°å·å¤§ä»¶') { const cfg = dataset.small_oversize_0_50; let fee = cfg.base[band]; if (weightLb > 1) fee += Math.ceil(weightLb - 1) * cfg.per_lb; return fee; }
      if (tier === 'å¤§å·å¤§ä»¶') { const cfg = dataset.large_oversize_0_50; let fee = cfg.base[band]; if (weightLb > 1) fee += Math.ceil(weightLb - 1) * cfg.per_lb; return fee; }
      if (tier === 'è¶…å¤§ä»¶') {
        if (weightLb <= 50) { const cfg = dataset.super_oversize_0_50; let fee = cfg.base[band]; if (weightLb > 1) fee += Math.ceil(weightLb - 1) * cfg.per_lb; return fee; }
        if (weightLb <= 70) { const cfg = dataset.super_oversize_50_70; const fee = cfg.base[band] + Math.ceil(weightLb - cfg.start_lb) * cfg.per_lb; return fee; }
        if (weightLb <= 150) { const cfg = dataset.super_oversize_70_150; const fee = cfg.base[band] + Math.ceil(weightLb - cfg.start_lb) * cfg.per_lb; return fee; }
        const cfg = dataset.super_oversize_gt_150; const fee = cfg.base[band] + Math.ceil(weightLb - cfg.start_lb) * cfg.per_lb; return fee;
      }
      return 'N/A';
    }

    // Main Calculation Controller
    function calculateAll() {
      // 1. Calculate Shipping Fee
      let l = parseFloat(document.getElementById('length').value);
      let w = parseFloat(document.getElementById('width').value);
      let h = parseFloat(document.getElementById('height').value);
      let lU = document.getElementById('lengthUnit').value;
      let wU = document.getElementById('widthUnit').value;
      let hU = document.getElementById('heightUnit').value;
      let actualWeight = parseFloat(document.getElementById('actualWeight').value);
      let weightU = document.getElementById('weightUnit').value;
      let productType = document.getElementById('productType').value;
      const auto = document.getElementById('autoSeason').checked;
      
      // Auto Season Check (Only if this function wasn't triggered by season toggles themselves to avoid loops, 
      // but here we just check checkbox state)
      // Note: autoDetectSeasonVersion modifies DOM, so be careful.
      // We will assume if auto is checked, we trust the current values or run autoDetect once on load/toggle.
      // To keep it simple, we don't call autoDetect here every time unless necessary, but let's do it for consistency if auto is checked.
      // Actually, better to only call it on specific events or load. Let's skip calling it here to avoid resetting user manual selection if they just unchecked it.
      
      if (lU === 'cm') l = cmToInch(l);
      if (wU === 'cm') w = cmToInch(w);
      if (hU === 'cm') h = cmToInch(h);

      let actualWeightOz = actualWeight;
      if (weightU === 'g') actualWeightOz = gToOz(actualWeight);
      if (weightU === 'lb') actualWeightOz = lbToOz(actualWeight);

      let volumeWeightLb = getVolumeWeight(l, w, h);
      let volumeWeightOz = volumeWeightLb * 16;

      let tierTemp = getTier(l, w, h, actualWeightOz);
      let shipWeightOz = actualWeightOz;
      if (!(tierTemp === "å°å·æ ‡å‡†å°ºå¯¸" || (tierTemp === "è¶…å¤§ä»¶" && actualWeightOz >= 2400))) {
        shipWeightOz = Math.max(actualWeightOz, volumeWeightOz);
      }
      let tier = getTier(l, w, h, shipWeightOz);

      const priceUSD = parseFloat(document.getElementById('priceUSD').value) || 0;
      let fee = getFee(productType, tier, shipWeightOz, priceUSD);
      
      let feeNum = 0;
      if (fee !== 'N/A') {
        feeNum = parseFloat(fee);
      }

      const dims = sort3(l,w,h);
      const sum = dims.l + 2*dims.w + 2*dims.h;
      const weightLb = shipWeightOz / 16;
      const surchargeSuggest = (tier === 'è¶…å¤§ä»¶' && weightLb <= 150 && (dims.l > 96 || sum > 130));
      const surchargeUSD = parseFloat(document.getElementById('surchargeUSD').value) || 0;
      const hasLithium = document.getElementById('hasLithium').checked;
      const lithiumUSD = (productType !== 'danger' && hasLithium) ? 0.11 : 0;
      const totalShippingFee = feeNum + surchargeUSD + lithiumUSD;

      // Update Shipping Result UI
      let res = `
        <b>å°ºå¯¸æ ‡å‡†ï¼š</b> ${tier}<br>
        <b>é…é€é‡é‡ï¼š</b> ${round2(shipWeightOz)} oz (${round2(ozToLb(shipWeightOz))} lb)<br>
        <b>åŸºæœ¬é…é€è´¹ï¼š</b> $${fee === 'N/A' ? 'N/A' : fee.toFixed(2)}<br>
        ${lithiumUSD > 0 ? `<b>é”‚ç”µæ± è´¹ï¼š</b> $${lithiumUSD.toFixed(2)}<br>` : ''}
        ${surchargeUSD > 0 ? `<b>é™„åŠ è´¹ï¼š</b> $${surchargeUSD.toFixed(2)}<br>` : ''}
        <div style="margin-top:5px;font-size:16px;color:#2a5d9f;"><b>æ€»é…é€è´¹ï¼š$${totalShippingFee.toFixed(2)}</b></div>
        ${surchargeSuggest ? '<div style="font-size:12px;color:#856404;margin-top:5px;">âš ï¸ å¯èƒ½äº§ç”Ÿç‰¹å¤§å·é™„åŠ è´¹</div>' : ''}
      `;
      const resBox = document.getElementById('shippingResult');
      resBox.style.display = 'block';
      resBox.innerHTML = res;

      // 2. Sync to Profit Calculator
      // Only sync if the calculated fee is valid (>0) and we want to auto-fill.
      // We will always update the input, but user can override. 
      // To allow override, we only update if the user hasn't manually focused/edited? 
      // Simpler: Just update it. If user wants to override, they do it after. 
      // But if they change dimensions, it overwrites again. This is usually desired.
      document.getElementById('fbaFeeInput').value = totalShippingFee.toFixed(2);

      // 3. Calculate Profit
      calculateProfit();
    }

    function calculateProfit() {
      const price = parseFloat(document.getElementById('profitPrice').value) || 0;
      const exchangeRate = parseFloat(document.getElementById('exchangeRate').value) || 7.2;
      
      const productCostCNY = parseFloat(document.getElementById('productCostCNY').value) || 0;
      const shippingCostCNY = parseFloat(document.getElementById('shippingCostCNY').value) || 0;
      const productCostUSD = (productCostCNY + shippingCostCNY) / exchangeRate;

      // Referral Fee Calculation
      const categorySelect = document.getElementById('categorySelect');
      const selectedCategory = categorySelect ? categorySelect.value : 'custom';
      let referralFee = 0;
      
      const customInput = document.getElementById('referralRateCustom');
      if (customInput) customInput.disabled = (selectedCategory !== 'custom');

      if (selectedCategory === 'custom') {
        const customRate = parseFloat(customInput ? customInput.value : 0) || 0;
        referralFee = price * customRate;
      } else {
        const rule = REFERRAL_RULES[selectedCategory];
        referralFee = calculateReferralFee(price, rule);
      }
      
      // Update Referral Fee Display
      const feeDisplay = document.getElementById('referralFeeDisplay');
      if (feeDisplay) feeDisplay.value = referralFee.toFixed(2);

      const fbaFee = parseFloat(document.getElementById('fbaFeeInput').value) || 0;
      const storageFee = parseFloat(document.getElementById('storageFee').value) || 0;
      const otherFee = parseFloat(document.getElementById('otherFee').value) || 0;

      // Returns
      const returnRate = parseFloat(document.getElementById('returnRate').value) / 100;
      const unsellableRate = parseFloat(document.getElementById('unsellableRate').value) / 100;
      
      // Refund Admin Fee: Min of $5.00 or 20% of Referral Fee
      const refundAdminFeeUnit = Math.min(5.00, referralFee * 0.20);
      
      // Return Loss Calculation
      // Formula: (Price + FBA Fee) * Return% * Unsellable% + RefundAdmin * Return%
      // Note: When a return happens:
      // 1. Amazon refunds customer (We lose Price).
      // 2. Amazon charges Refund Admin Fee.
      // 3. Amazon returns Referral Fee (minus Admin Fee). So we get back (ReferralFee - AdminFee).
      // 4. We do NOT get back FBA Fee.
      // 5. If unsellable, we lose the COGS.
      
      // Simplified "Loss" approach per requirements:
      // Requirement Formula: `é€€è´§æŸå¤± = (å”®ä»· + FBAé…é€è´¹) * é€€è´§ç‡ * ä¸å¯å”®æ¯”ä¾‹ + é€€æ¬¾ç®¡ç†è´¹ * é€€è´§ç‡`
      // Let's stick to the requirement formula exactly to be safe, though "å”®ä»·" usually implies we lose the item cost? 
      // Wait, if it's unsellable, we lose the Manufacturing Cost + Shipping Cost (COGS), not the Selling Price.
      // But the formula says "å”®ä»·". Maybe it implies lost revenue opportunity? 
      // Usually: Cost of Return = (Non-refundable FBA Fees + Refund Admin Fee) * Return% + (COGS) * Return% * Unsellable%
      // The requirement formula: (Selling Price + FBA Fee) * Return% * Unsellable% ... this looks like we are refunding the customer (Price) AND paying FBA?
      // Actually, let's look at the requirement again carefully:
      // `é€€è´§æŸå¤± = (å”®ä»· + FBAé…é€è´¹) * é€€è´§ç‡ * ä¸å¯å”®æ¯”ä¾‹ + é€€æ¬¾ç®¡ç†è´¹ * é€€è´§ç‡`
      // If Unsellable: We lose the Item (Price? No, Cost). 
      // Let's assume the user wants exactly this formula.
      
      const returnLoss = (price + fbaFee) * returnRate * unsellableRate + refundAdminFeeUnit * returnRate;

      // Ads
      const acos = parseFloat(document.getElementById('acos').value) / 100;
      const adsCost = price * acos;

      // Totals
      const amazonPayout = price - referralFee - fbaFee;
      const totalOperatingCost = adsCost + storageFee + returnLoss + otherFee; // + Promotion Cost if we had it
      const grossProfit = amazonPayout - productCostUSD; // This is a bit weird. Gross Profit usually = Revenue - COGS.
      // Requirement: Gross Profit = Payout - (Product Cost + Shipping Cost). 
      // Payout already deducted Amazon Fees. So this is "Gross Profit after Amazon Fees". Okay.
      const realGrossProfit = amazonPayout - productCostUSD;
      
      const netProfit = realGrossProfit - totalOperatingCost;
      const netProfitMargin = (price > 0) ? (netProfit / price) : 0;
      const breakEvenACoS = (price > 0) ? (realGrossProfit / price) : 0; // Assuming Operating Costs (Storage/Returns) are 0 for BE ACoS? Or should we deduct them?
      // Requirement: Break-even ACoS = æ¯›åˆ©æ¶¦ / å”®ä»·. (Gross Profit / Price).
      // If we use the definition of Gross Profit above (Payout - COGS), then yes.
      
      // Update UI
      document.getElementById('resPayout').textContent = `$${amazonPayout.toFixed(2)}`;
      document.getElementById('resTotalCost').textContent = `$${(productCostUSD + referralFee + fbaFee + totalOperatingCost).toFixed(2)}`;
      document.getElementById('resGrossProfit').textContent = `$${realGrossProfit.toFixed(2)}`;
      document.getElementById('resAds').textContent = `$${adsCost.toFixed(2)}`;
      document.getElementById('resReturnLoss').textContent = `$${returnLoss.toFixed(2)}`;
      
      const npEl = document.getElementById('resNetProfit');
      npEl.textContent = `$${netProfit.toFixed(2)}`;
      npEl.className = netProfit >= 0 ? 'profit-positive' : 'profit-negative';
      
      document.getElementById('resMargin').textContent = `${(netProfitMargin * 100).toFixed(2)}%`;
      document.getElementById('resBreakEven').textContent = `${(breakEvenACoS * 100).toFixed(2)}%`;
      
      // Emoji
      const emojiEl = document.getElementById('profitEmoji');
      if (netProfitMargin > 0.2) emojiEl.textContent = 'ğŸ˜Š'; // High profit
      else if (netProfitMargin > 0.05) emojiEl.textContent = 'ğŸ˜'; // Low profit
      else emojiEl.textContent = 'ğŸ˜©'; // Loss or very low

      // CNY Net Profit
      const netProfitCNY = netProfit * exchangeRate;
      document.getElementById('resNetProfitCNY').textContent = `Â¥${netProfitCNY.toFixed(2)}`;
      
      // --- Batch Analysis Calculation ---
      const shipmentQty = parseInt(document.getElementById('shipmentQty').value) || 1;
      
      // Total Investment (CNY) = (ProductCostCNY + ShippingCostCNY) * Qty
      // Note: This is the upfront investment.
      const totalInvestmentCNY = (productCostCNY + shippingCostCNY) * shipmentQty;
      
      // Total Net Profit (CNY)
      const totalNetProfitCNY = netProfitCNY * shipmentQty;
      
      // Total Payout (USD)
      const totalPayoutUSD = amazonPayout * shipmentQty;
      
      // ROI = Total Net Profit / Total Investment
      let roi = 0;
      if (totalInvestmentCNY > 0) {
        roi = (totalNetProfitCNY / totalInvestmentCNY);
      } else if (totalNetProfitCNY > 0) {
        roi = 999; // Infinite return if no investment?
      }
      
      document.getElementById('batchInvestment').textContent = `Â¥${totalInvestmentCNY.toFixed(2)}`;
      document.getElementById('batchNetProfit').textContent = `Â¥${totalNetProfitCNY.toFixed(2)}`;
      document.getElementById('batchNetProfit').className = totalNetProfitCNY >= 0 ? 'profit-positive' : 'profit-negative';
      document.getElementById('batchPayout').textContent = `$${totalPayoutUSD.toFixed(2)}`;
      document.getElementById('batchROI').textContent = `${(roi * 100).toFixed(2)}%`;
      document.getElementById('batchROI').className = roi >= 0 ? 'profit-positive' : 'profit-negative';

      updateChart(productCostUSD, fbaFee, referralFee, adsCost, totalOperatingCost, netProfit, price);
    }

    function syncPrice() {
      document.getElementById('profitPrice').value = document.getElementById('priceUSD').value;
      calculateAll();
    }
    function syncPriceFromProfit() {
      document.getElementById('priceUSD').value = document.getElementById('profitPrice').value;
      calculateAll();
    }

    function syncSlider(inputId, sliderId) {
      document.getElementById(sliderId).value = document.getElementById(inputId).value;
      updateSliderDisplay();
    }
    function syncInput(inputId, sliderId) {
      document.getElementById(inputId).value = document.getElementById(sliderId).value;
      updateSliderDisplay();
    }
    function updateSliderDisplay() {
      document.getElementById('returnRateDisplay').textContent = document.getElementById('returnRateSlider').value;
      document.getElementById('acosDisplay').textContent = document.getElementById('acosSlider').value;
    }

    function resetInputs() {
      document.getElementById('length').value = 0;
      document.getElementById('width').value = 0;
      document.getElementById('height').value = 0;
      document.getElementById('actualWeight').value = 0;
      document.getElementById('priceUSD').value = 0;
      document.getElementById('surchargeUSD').value = 0;
      document.getElementById('hasLithium').checked = false;
      document.getElementById('profitPrice').value = 0;
      document.getElementById('productCostCNY').value = 0;
      document.getElementById('shippingCostCNY').value = 0;
      document.getElementById('fbaFeeInput').value = 0;
      
      document.getElementById('shippingResult').style.display = 'none';
      
      calculateAll();
    }

    function toggleRules() {
      const el = document.getElementById('rulesSection');
      if (el.classList.contains('hidden')) el.classList.remove('hidden');
      else el.classList.add('hidden');
    }

    // --- Table Logic (Ported) ---
    function switchTab(type) {
      document.querySelectorAll('.tab-btns button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.fee-table').forEach(tab => tab.classList.remove('active'));
      if (type === 'normal') {
        document.querySelector('.tab-btns button:nth-child(1)').classList.add('active');
        document.getElementById('fee-normal').classList.add('active');
      } else if (type === 'apparel') {
        document.querySelector('.tab-btns button:nth-child(2)').classList.add('active');
        document.getElementById('fee-apparel').classList.add('active');
      } else if (type === 'danger') {
        document.querySelector('.tab-btns button:nth-child(3)').classList.add('active');
        document.getElementById('fee-danger').classList.add('active');
      }
      renderCurrentFeeTable();
    }

    function showFeeTab() {
      let type = document.getElementById('productType').value;
      switchTab(type);
      const lithiumEl = document.getElementById('hasLithium');
      if (type === 'danger') { lithiumEl.checked = false; lithiumEl.disabled = true; } else { lithiumEl.disabled = false; }
    }

    function onAutoSeasonToggle() {
      const auto = document.getElementById('autoSeason').checked;
      document.getElementById('season').disabled = auto;
      document.getElementById('version').disabled = auto;
      const ts = document.getElementById('tableSeason');
      const tv = document.getElementById('tableVersion');
      const tas = document.getElementById('tableAutoSeason');
      if (ts && tv) {
        ts.disabled = auto;
        tv.disabled = auto;
        if (auto) {
          autoDetectSeasonVersion();
          ts.value = document.getElementById('season').value;
          tv.value = document.getElementById('version').value;
        }
      }
      if (tas) tas.checked = auto;
      if (auto) autoDetectSeasonVersion();
    }

    function getCurrentTableType() {
      if (document.getElementById('fee-normal').classList.contains('active')) return 'normal';
      if (document.getElementById('fee-apparel').classList.contains('active')) return 'apparel';
      if (document.getElementById('fee-danger').classList.contains('active')) return 'danger';
      return 'normal';
    }

    function getTableTitle(type) {
      const titles = { 'normal': 'æ™®é€šå•†å“é…é€è´¹ç”¨è¡¨', 'apparel': 'æœè£…é…é€è´¹ç”¨è¡¨', 'danger': 'å±é™©å“é…é€è´¹ç”¨è¡¨' };
      return titles[type] || 'é…é€è´¹ç”¨è¡¨';
    }

    function downloadCurrentTable() {
      const type = getCurrentTableType();
      const title = getTableTitle(type);
      const tableId = `fee-${type}`;
      const table = document.getElementById(tableId).querySelector('table');
      if (!table) { alert('æœªæ‰¾åˆ°è¡¨æ ¼æ•°æ®'); return; }
      let csv = '\uFEFF';
      const seasonLabel = document.getElementById('season').value === 'peak' ? 'æ—ºå­£' : 'éæ—ºå­£';
      const versionLabel = document.getElementById('version').value;
      csv += `${title} (${seasonLabel}-${versionLabel})\n\n`;
      const rows = table.querySelectorAll('tr');
      rows.forEach((row) => {
        const cells = row.querySelectorAll('th, td');
        const rowData = [];
        cells.forEach(cell => {
          let text = cell.textContent.trim();
          if (text.includes(',') || text.includes('"') || text.includes('\n')) {
            text = '"' + text.replace(/"/g, '""') + '"';
          }
          rowData.push(text);
        });
        csv += rowData.join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `${title}_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      alert('ä¸‹è½½å·²å¼€å§‹');
    }

    function renderCurrentFeeTable() {
      const type = getCurrentTableType();
      const seasonKey = getSeasonKey();
      const dataset = feeData[type][seasonKey];
      const container = document.getElementById(`fee-${type}`);
      if (!dataset) { container.innerHTML = '<div style="color:#888">æš‚æ— æ•°æ®</div>'; return; }
      const rows = [];
      rows.push('<table><tr><th>å°ºå¯¸åˆ†æ®µ</th><th>é‡é‡èŒƒå›´</th><th>è´¹ç”¨(<$10)</th><th>è´¹ç”¨($10~$50)</th><th>è´¹ç”¨(>$50)</th></tr>');
      const pushRow = (tier, range, lt10, mid, high) => { rows.push(`<tr><td>${tier}</td><td>${range}</td><td>$${lt10.toFixed(2)}</td><td>$${mid.toFixed(2)}</td><td>$${high.toFixed(2)}</td></tr>`); };
      const ss = dataset.small_standard;
      for (let i = 0; i < ss.steps.length; i++) {
        const range = (i === 0 ? 'â‰¤' + ss.steps[i] + 'ç›å¸' : ss.steps[i-1] + 'è‡³' + ss.steps[i] + 'ç›å¸');
        pushRow('å°å·æ ‡å‡†å°ºå¯¸', range, ss.lt10[i], ss.mid[i], ss.high[i]);
      }
      const ls = dataset.large_standard;
      for (let i = 0; i < ls.pre3_steps_oz.length; i++) {
        const prev = i === 0 ? 0 : ls.pre3_steps_oz[i-1];
        const curr = ls.pre3_steps_oz[i];
        const range = (i === 0 ? 'â‰¤' + curr + 'ç›å¸' : (prev + 'è‡³' + curr + 'ç›å¸'));
        pushRow('å¤§å·æ ‡å‡†å°ºå¯¸', range, ls.lt10_pre3[i], ls.mid_pre3[i], ls.high_pre3[i]);
      }
      if (ls.post3_base) {
        const incText = type === 'apparel' ? ` + æ¯åŠç£…$${(ls.post3_increment_per_half_lb || 0).toFixed(2)}` : ` + æ¯4ç›å¸$${(ls.post3_increment_per_4oz || 0).toFixed(2)}`;
        rows.push(`<tr><td>å¤§å·æ ‡å‡†å°ºå¯¸</td><td>3è‡³20ç£…</td><td>$${ls.post3_base.lt10.toFixed(2)}${incText}</td><td>$${ls.post3_base.mid.toFixed(2)}${incText}</td><td>$${ls.post3_base.high.toFixed(2)}${incText}</td></tr>`);
      }
      const so = dataset.small_oversize_0_50;
      if (so) rows.push(`<tr><td>å°å·å¤§ä»¶</td><td>0è‡³50ç£…</td><td>$${so.base.lt10.toFixed(2)} + æ¯ç£…$${so.per_lb.toFixed(2)}</td><td>$${so.base.mid.toFixed(2)} + æ¯ç£…$${so.per_lb.toFixed(2)}</td><td>$${so.base.high.toFixed(2)} + æ¯ç£…$${so.per_lb.toFixed(2)}</td></tr>`);
      const lo = dataset.large_oversize_0_50;
      if (lo) rows.push(`<tr><td>å¤§å·å¤§ä»¶</td><td>0è‡³50ç£…</td><td>$${lo.base.lt10.toFixed(2)} + æ¯ç£…$${lo.per_lb.toFixed(2)}</td><td>$${lo.base.mid.toFixed(2)} + æ¯ç£…$${lo.per_lb.toFixed(2)}</td><td>$${lo.base.high.toFixed(2)} + æ¯ç£…$${lo.per_lb.toFixed(2)}</td></tr>`);
      const su0 = dataset.super_oversize_0_50;
      if (su0) rows.push(`<tr><td>è¶…å¤§ä»¶</td><td>0è‡³50ç£…</td><td>$${su0.base.lt10.toFixed(2)} + æ¯ç£…$${su0.per_lb.toFixed(2)}</td><td>$${su0.base.mid.toFixed(2)} + æ¯ç£…$${su0.per_lb.toFixed(2)}</td><td>$${su0.base.high.toFixed(2)} + æ¯ç£…$${su0.per_lb.toFixed(2)}</td></tr>`);
      const su5070 = dataset.super_oversize_50_70;
      if (su5070) rows.push(`<tr><td>è¶…å¤§ä»¶</td><td>50è‡³70ç£…</td><td>$${su5070.base.lt10.toFixed(2)} + è¶…å‡ºé¦–é‡${su5070.start_lb}ç£…æ¯ç£…$${su5070.per_lb.toFixed(2)}</td><td>$${su5070.base.mid.toFixed(2)} + è¶…å‡ºé¦–é‡${su5070.start_lb}ç£…æ¯ç£…$${su5070.per_lb.toFixed(2)}</td><td>$${su5070.base.high.toFixed(2)} + è¶…å‡ºé¦–é‡${su5070.start_lb}ç£…æ¯ç£…$${su5070.per_lb.toFixed(2)}</td></tr>`);
      const su70150 = dataset.super_oversize_70_150;
      if (su70150) rows.push(`<tr><td>è¶…å¤§ä»¶</td><td>70è‡³150ç£…</td><td>$${su70150.base.lt10.toFixed(2)} + è¶…å‡ºé¦–é‡${su70150.start_lb}ç£…æ¯ç£…$${su70150.per_lb.toFixed(2)}</td><td>$${su70150.base.mid.toFixed(2)} + è¶…å‡ºé¦–é‡${su70150.start_lb}ç£…æ¯ç£…$${su70150.per_lb.toFixed(2)}</td><td>$${su70150.base.high.toFixed(2)} + è¶…å‡ºé¦–é‡${su70150.start_lb}ç£…æ¯ç£…$${su70150.per_lb.toFixed(2)}</td></tr>`);
      const su150 = dataset.super_oversize_gt_150;
      if (su150) rows.push(`<tr><td>è¶…å¤§ä»¶</td><td>è¶…è¿‡150ç£…</td><td>$${su150.base.lt10.toFixed(2)} + è¶…å‡ºé¦–é‡${su150.start_lb}ç£…æ¯ç£…$${su150.per_lb.toFixed(2)}</td><td>$${su150.base.mid.toFixed(2)} + è¶…å‡ºé¦–é‡${su150.start_lb}ç£…æ¯ç£…$${su150.per_lb.toFixed(2)}</td><td>$${su150.base.high.toFixed(2)} + è¶…å‡ºé¦–é‡${su150.start_lb}ç£…æ¯ç£…$${su150.per_lb.toFixed(2)}</td></tr>`);
      rows.push('</table>');
      container.innerHTML = rows.join('');
    }

    function onTableSeasonChange(el) {
      document.getElementById('autoSeason').checked = false;
      document.getElementById('season').disabled = false;
      document.getElementById('version').disabled = false;
      const tas = document.getElementById('tableAutoSeason');
      if (tas) tas.checked = false;
      document.getElementById('season').value = el.value;
      renderCurrentFeeTable();
    }
    function onTableVersionChange(el) {
      document.getElementById('autoSeason').checked = false;
      document.getElementById('season').disabled = false;
      document.getElementById('version').disabled = false;
      const tas = document.getElementById('tableAutoSeason');
      if (tas) tas.checked = false;
      document.getElementById('version').value = el.value;
      renderCurrentFeeTable();
    }
    function onTableAutoSeasonToggle() {
      const checked = document.getElementById('tableAutoSeason').checked;
      document.getElementById('autoSeason').checked = checked;
      onAutoSeasonToggle();
      renderCurrentFeeTable();
    }

      
      // Referral Fee Rules (Ported from ä½£é‡‘ç‡.md)
      const REFERRAL_RULES = {
        "Amazon Device Accessories": { name: "äºšé©¬é€Šè®¾å¤‡é…ä»¶", rate: 0.45, min: 0.30 },
        "Automotive": { name: "æ±½è½¦å’Œæˆ·å¤–åŠ¨åŠ›è®¾å¤‡", rate: 0.12, min: 0.30 },
        "Baby": { name: "æ¯å©´", type: "threshold", threshold: 10.00, lowRate: 0.08, highRate: 0.15, min: 0.30 },
        "Backpacks": { name: "èƒŒåŒ…ã€æ‰‹æåŒ…å’Œç®±åŒ…", rate: 0.15, min: 0.30 },
        "Power Tools": { name: "åŸºç¡€è®¾å¤‡ç”µåŠ¨å·¥å…·", rate: 0.12, min: 0.30 },
        "Beauty": { name: "ç¾å¦†å’Œä¸ªæŠ¤å¥åº·", type: "threshold", threshold: 10.00, lowRate: 0.08, highRate: 0.15, min: 0.30 },
        "Business": { name: "å•†ä¸šã€å·¥ä¸šä¸ç§‘å­¦ç”¨å“", rate: 0.12, min: 0.30 },
        "Clothing": { name: "æœè£…å’Œé…é¥°", type: "threshold_multi", ranges: [{max:15, rate:0.05}, {max:20, rate:0.10}, {max:Infinity, rate:0.17}], min: 0.30 },
        "Small Appliances": { name: "å°å‹ç”µå™¨", type: "tiered", threshold: 300.00, rate1: 0.15, rate2: 0.08, min: 0.30 },
        "Computers": { name: "ç”µè„‘", rate: 0.08, min: 0.30 },
        "Consumer Electronics": { name: "æ¶ˆè´¹ç±»ç”µå­äº§å“", rate: 0.08, min: 0.30 },
        "Electronics Accessories": { name: "ç”µå­äº§å“é…ä»¶", type: "tiered", threshold: 100.00, rate1: 0.15, rate2: 0.08, min: 0.30 },
        "Other": { name: "å…¶ä»–", rate: 0.15, min: 0.30 },
        "Eyewear": { name: "çœ¼é•œ", rate: 0.15, min: 0.30 },
        "Fine Art": { name: "è‰ºæœ¯å“", type: "tiered_multi", ranges: [{limit:100, rate:0.20}, {limit:1000, rate:0.15}, {limit:5000, rate:0.10}, {limit:Infinity, rate:0.05}], min: 0 },
        "Footwear": { name: "é‹é´", rate: 0.15, min: 0.30 },
        "Full-Size Appliances": { name: "å…¨å°ºå¯¸ç”µå™¨", rate: 0.08, min: 0.30 },
        "Furniture": { name: "å®¶å…·", type: "tiered", threshold: 200.00, rate1: 0.15, rate2: 0.10, min: 0.30 },
        "Gift Cards": { name: "ç¤¼å“å¡", rate: 0.20, min: 0 },
        "Grocery": { name: "é£Ÿå“", type: "threshold", threshold: 15.00, lowRate: 0.08, highRate: 0.15, min: 0 },
        "Home & Kitchen": { name: "å®¶å±…åŠå¨æˆ¿ç”¨å“", rate: 0.15, min: 0.30 },
        "Jewelry": { name: "ç å®é¦–é¥°", type: "tiered", threshold: 250.00, rate1: 0.20, rate2: 0.05, min: 0.30 },
        "Lawn & Garden": { name: "è‰åªå’Œå›­è‰º", rate: 0.15, min: 0.30 },
        "Mowers": { name: "å‰²è‰æœºå’Œé™¤é›ªæœº", type: "threshold", threshold: 500.00, lowRate: 0.15, highRate: 0.08, min: 0.30 },
        "Mattresses": { name: "åºŠå«", rate: 0.15, min: 0.30 },
        "Media": { name: "åª’ä»‹ç±»å•†å“", rate: 0.15, min: 0 },
        "Musical Instruments": { name: "ä¹å™¨å’Œå½±éŸ³åˆ¶ä½œ", rate: 0.15, min: 0.30 },
        "Office Products": { name: "åŠå…¬ç”¨å“", rate: 0.15, min: 0.30 },
        "Pet Products": { name: "å® ç‰©ç”¨å“", rate: 0.15, min: 0.30 },
        "Sports": { name: "è¿åŠ¨æˆ·å¤–", rate: 0.15, min: 0.30 },
        "Tires": { name: "è½®èƒ", rate: 0.10, min: 0.30 },
        "Tools": { name: "å·¥å…·å’Œå®¶å±…è£…ä¿®", rate: 0.15, min: 0.30 },
        "Toys": { name: "ç©å…·å’Œæ¸¸æˆ", rate: 0.15, min: 0.30 },
        "Video Game Consoles": { name: "è§†é¢‘æ¸¸æˆæœº", rate: 0.08, min: 0 },
        "Video Games": { name: "è§†é¢‘æ¸¸æˆå’Œæ¸¸æˆé…ä»¶", rate: 0.15, min: 0 },
        "Watches": { name: "é’Ÿè¡¨", type: "tiered", threshold: 1500.00, rate1: 0.16, rate2: 0.03, min: 0.30 }
      };

      function calculateReferralFee(price, rule) {
        if (!rule) return 0;
        let fee = 0;
        if (rule.type === 'threshold') {
          // If price <= threshold, use lowRate, else highRate (applied to WHOLE price)
          // Exception: Some categories might apply different logic, but based on "Baby" example: <=$10 -> 8%, >$10 -> 15%.
          const rate = price <= rule.threshold ? rule.lowRate : rule.highRate;
          fee = price * rate;
        } else if (rule.type === 'threshold_multi') {
           // Find the first range that covers the price
           let rate = rule.ranges[rule.ranges.length - 1].rate;
           for (let r of rule.ranges) {
             if (price <= r.max) {
               rate = r.rate;
               break;
             }
           }
           fee = price * rate;
        } else if (rule.type === 'tiered') {
          // Portion <= threshold at rate1, portion > threshold at rate2
          if (price <= rule.threshold) {
            fee = price * rule.rate1;
          } else {
            fee = (rule.threshold * rule.rate1) + ((price - rule.threshold) * rule.rate2);
          }
        } else if (rule.type === 'tiered_multi') {
           // Multiple tiers
           let remaining = price;
           let prevLimit = 0;
           for (let r of rule.ranges) {
             const limit = r.limit;
             const rangeSize = limit - prevLimit; // Size of this tier
             const taxableAmount = Math.min(remaining, rangeSize);
             if (taxableAmount > 0) {
               fee += taxableAmount * r.rate;
               remaining -= taxableAmount;
             }
             prevLimit = limit;
             if (remaining <= 0) break;
           }
        } else {
          // Simple flat rate
          fee = price * rule.rate;
        }
        // Apply Minimum
        if (rule.min && fee < rule.min) {
          fee = rule.min;
        }
        return fee;
      }

      // --- New Features: Chart, History, Copy ---

      function updateChart(cost, fba, ref, ads, other, profit, price) {
        if (price <= 0) return;
        const total = price; 
        const getPct = (val) => Math.max(0, (val / total) * 100);
        
        const costPct = getPct(cost);
        const fbaPct = getPct(fba);
        const refPct = getPct(ref);
        const adsPct = getPct(ads);
        // 'other' passed in includes adsCost in calculateAll logic (totalOperatingCost).
        // So we subtract ads to isolate "True Other".
        const realOther = Math.max(0, other - ads); 
        const realOtherPct = getPct(realOther);
        
        // Profit for display. If negative, chart doesn't show "negative bar" well in this simple stack.
        // We only show positive profit segment.
        const profitPct = profit > 0 ? getPct(profit) : 0;
        
        const chart = document.getElementById('costChart');
        if(chart) {
            chart.innerHTML = `
                <div class="chart-segment bg-cost" style="width:${costPct}%" title="é‡‡è´­+å¤´ç¨‹: $${cost.toFixed(2)} (${costPct.toFixed(1)}%)"></div>
                <div class="chart-segment bg-fba" style="width:${fbaPct}%" title="FBAé…é€: $${fba.toFixed(2)} (${fbaPct.toFixed(1)}%)"></div>
                <div class="chart-segment bg-ref" style="width:${refPct}%" title="ä½£é‡‘: $${ref.toFixed(2)} (${refPct.toFixed(1)}%)"></div>
                <div class="chart-segment bg-ads" style="width:${adsPct}%" title="å¹¿å‘Š: $${ads.toFixed(2)} (${adsPct.toFixed(1)}%)"></div>
                <div class="chart-segment bg-loss" style="width:${realOtherPct}%" title="å…¶ä»–(é€€è´§/ä»“å‚¨): $${realOther.toFixed(2)} (${realOtherPct.toFixed(1)}%)"></div>
                ${profit > 0 ? `<div class="chart-segment bg-profit" style="width:${profitPct}%" title="å‡€åˆ©æ¶¦: $${profit.toFixed(2)} (${profitPct.toFixed(1)}%)"></div>` : ''}
            `;
        }
      }

      const STORAGE_KEY = 'fba_calc_history';

      function saveHistory() {
        const name = document.getElementById('productName').value || 'æœªå‘½åå•†å“';
        const price = document.getElementById('priceUSD').value;
        const netProfit = document.getElementById('resNetProfit').textContent;
        const margin = document.getElementById('resMargin').textContent;
        const time = new Date().toLocaleString('zh-CN', { hour12: false });
        
        const data = {
            id: Date.now(),
            time, name, price, netProfit, margin,
            inputs: {
                length: document.getElementById('length').value,
                width: document.getElementById('width').value,
                height: document.getElementById('height').value,
                lengthUnit: document.getElementById('lengthUnit').value,
                widthUnit: document.getElementById('widthUnit').value,
                heightUnit: document.getElementById('heightUnit').value,
                actualWeight: document.getElementById('actualWeight').value,
                weightUnit: document.getElementById('weightUnit').value,
                productType: document.getElementById('productType').value,
                hasLithium: document.getElementById('hasLithium').checked,
                priceUSD: document.getElementById('priceUSD').value,
                season: document.getElementById('season').value,
                version: document.getElementById('version').value,
                autoSeason: document.getElementById('autoSeason').checked,
                surchargeUSD: document.getElementById('surchargeUSD').value,
                exchangeRate: document.getElementById('exchangeRate').value,
                productCostCNY: document.getElementById('productCostCNY').value,
                shippingCostCNY: document.getElementById('shippingCostCNY').value,
                categorySelect: document.getElementById('categorySelect').value,
                referralRateCustom: document.getElementById('referralRateCustom').value,
                fbaFeeInput: document.getElementById('fbaFeeInput').value,
                storageFee: document.getElementById('storageFee').value,
                otherFee: document.getElementById('otherFee').value,
                returnRate: document.getElementById('returnRate').value,
                unsellableRate: document.getElementById('unsellableRate').value,
                acos: document.getElementById('acos').value,
                // Sliders
                returnRateSlider: document.getElementById('returnRateSlider').value,
                acosSlider: document.getElementById('acosSlider').value,
                // Batch
                shipmentQty: document.getElementById('shipmentQty').value
            }
        };
        
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        history.unshift(data);
        if (history.length > 20) history.pop(); // Limit to 20
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        renderHistory();
        alert('è®°å½•å·²ä¿å­˜');
      }

      function loadHistory(id) {
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        const item = history.find(i => i.id === id);
        if (!item) return;
        
        const i = item.inputs;
        const setVal = (k, v) => { const el = document.getElementById(k); if(el && v !== undefined) el.value = v; };
        const setChk = (k, v) => { const el = document.getElementById(k); if(el && v !== undefined) el.checked = v; };
        
        setVal('productName', item.name);
        setVal('length', i.length); setVal('width', i.width); setVal('height', i.height);
        setVal('lengthUnit', i.lengthUnit); setVal('widthUnit', i.widthUnit); setVal('heightUnit', i.heightUnit);
        setVal('actualWeight', i.actualWeight); setVal('weightUnit', i.weightUnit);
        setVal('productType', i.productType); setChk('hasLithium', i.hasLithium);
        setVal('priceUSD', i.priceUSD); setVal('profitPrice', i.priceUSD);
        setVal('season', i.season); setVal('version', i.version); setChk('autoSeason', i.autoSeason);
        setVal('surchargeUSD', i.surchargeUSD);
        setVal('exchangeRate', i.exchangeRate);
        setVal('productCostCNY', i.productCostCNY); setVal('shippingCostCNY', i.shippingCostCNY);
        setVal('categorySelect', i.categorySelect);
        setVal('referralRateCustom', i.referralRateCustom);
        setVal('fbaFeeInput', i.fbaFeeInput);
        setVal('storageFee', i.storageFee); setVal('otherFee', i.otherFee);
        setVal('returnRate', i.returnRate); setVal('unsellableRate', i.unsellableRate);
        setVal('acos', i.acos);
        
        // Sync sliders
        if (i.returnRateSlider) { setVal('returnRateSlider', i.returnRateSlider); document.getElementById('returnRateDisplay').textContent = i.returnRateSlider; }
        if (i.acosSlider) { setVal('acosSlider', i.acosSlider); document.getElementById('acosDisplay').textContent = i.acosSlider; }
        
        setVal('shipmentQty', i.shipmentQty);

        showFeeTab(); 
        onAutoSeasonToggle();
        calculateAll();
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function deleteHistory(id) {
        if(!confirm('ç¡®å®šåˆ é™¤æ­¤è®°å½•?')) return;
        let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        history = history.filter(i => i.id !== id);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
        renderHistory();
      }

      function clearHistory() {
        if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
            localStorage.removeItem(STORAGE_KEY);
            renderHistory();
        }
      }

      function renderHistory() {
        const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        const tbody = document.getElementById('historyList');
        if (!tbody) return;
        tbody.innerHTML = history.map(item => `
            <tr>
                <td>${item.time.split(' ')[0]}</td>
                <td title="${item.name}">${item.name}</td>
                <td>$${item.price}</td>
                <td class="${String(item.netProfit).includes('-') ? 'profit-negative' : 'profit-positive'}">${item.netProfit}</td>
                <td>${item.margin}</td>
                <td>
                    <button class="secondary btn-sm btn-load" onclick="loadHistory(${item.id})">åŠ è½½</button>
                    <button class="secondary btn-sm btn-danger" onclick="deleteHistory(${item.id})">åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
      }

      function copyResults() {
        const payout = document.getElementById('resPayout').textContent;
        const totalCost = document.getElementById('resTotalCost').textContent;
        const profit = document.getElementById('resNetProfit').textContent;
        const margin = document.getElementById('resMargin').textContent;
        const name = document.getElementById('productName').value || 'å•†å“';
        
        const batchInvestment = document.getElementById('batchInvestment').textContent;
        const batchNetProfit = document.getElementById('batchNetProfit').textContent;
        const batchPayout = document.getElementById('batchPayout').textContent;
        const batchROI = document.getElementById('batchROI').textContent;
        const shipmentQty = document.getElementById('shipmentQty').value;

        // Simple text copy
        const text = `ã€${name}ã€‘åˆ©æ¶¦åˆ†æ
å›æ¬¾: ${payout}
æ€»æˆæœ¬: ${totalCost}
å‡€åˆ©æ¶¦: ${profit}
å‡€åˆ©ç‡: ${margin}

ã€æ•´æ‰¹åˆ†æ (æ•°é‡: ${shipmentQty})ã€‘
æ€»èµ„é‡‘æŠ•å…¥: ${batchInvestment}
é¢„è®¡æ€»å‡€åˆ©: ${batchNetProfit}
æœ€åå›æ¬¾: ${batchPayout}
æŠ•èµ„å›æŠ¥ç‡: ${batchROI}`;
        
        navigator.clipboard.writeText(text).then(() => {
            alert('ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        });
      }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      // Populate Category Select
      const catSelect = document.getElementById('categorySelect');
      const sortedKeys = Object.keys(REFERRAL_RULES).sort((a,b) => REFERRAL_RULES[a].name.localeCompare(REFERRAL_RULES[b].name, 'zh'));
      
      sortedKeys.forEach(key => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = `${REFERRAL_RULES[key].name} (${key})`;
        catSelect.appendChild(option);
      });
      
      autoDetectSeasonVersion();
      onAutoSeasonToggle();
      
      // Removed old listener for 'referralRate' as it's replaced
      // But we need to handle the new UI logic
      
      renderHistory(); // Init history table
      calculateAll();
    });
  </script>
</body>
</html>
